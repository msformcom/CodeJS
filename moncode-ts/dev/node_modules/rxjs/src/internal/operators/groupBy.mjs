import { Observable } from '../Observable.mjs';
import { innerFrom } from '../observable/innerFrom.mjs';
import { Subject } from '../Subject.mjs';
import { operate } from '../util/lift.mjs';
import { createOperatorSubscriber, OperatorSubscriber } from './OperatorSubscriber.mjs';
// Impl
export function groupBy(keySelector, elementOrOptions, duration, connector) {
    return operate((source, subscriber) => {
        let element;
        if (!elementOrOptions || typeof elementOrOptions === 'function') {
            element = elementOrOptions;
        }
        else {
            ({ duration, element, connector } = elementOrOptions);
        }
        // A lookup for the groups that we have so far.
        const groups = new Map();
        // Used for notifying all groups and the subscriber in the same way.
        const notify = (cb) => {
            groups.forEach(cb);
            cb(subscriber);
        };
        // Used to handle errors from the source, AND errors that occur during the
        // next call from the source.
        const handleError = (err) => notify((consumer) => consumer.error(err));
        // The number of actively subscribed groups
        let activeGroups = 0;
        // Whether or not teardown was attempted on this subscription.
        let teardownAttempted = false;
        // Capturing a reference to this, because we need a handle to it
        // in `createGroupedObservable` below. This is what we use to
        // subscribe to our source observable. This sometimes needs to be unsubscribed
        // out-of-band with our `subscriber` which is the downstream subscriber, or destination,
        // in cases where a user unsubscribes from the main resulting subscription, but
        // still has groups from this subscription subscribed and would expect values from it
        // Consider:  `source.pipe(groupBy(fn), take(2))`.
        const groupBySourceSubscriber = new OperatorSubscriber(subscriber, (value) => {
            // Because we have to notify all groups of any errors that occur in here,
            // we have to add our own try/catch to ensure that those errors are propagated.
            // OperatorSubscriber will only send the error to the main subscriber.
            try {
                const key = keySelector(value);
                let group = groups.get(key);
                if (!group) {
                    // Create our group subject
                    groups.set(key, (group = connector ? connector() : new Subject()));
                    // Emit the grouped observable. Note that we can't do a simple `asObservable()` here,
                    // because the grouped observable has special semantics around reference counting
                    // to ensure we don't sever our connection to the source prematurely.
                    const grouped = createGroupedObservable(key, group);
                    subscriber.next(grouped);
                    if (duration) {
                        const durationSubscriber = createOperatorSubscriber(
                        // Providing the group here ensures that it is disposed of -- via `unsubscribe` --
                        // when the duration subscription is torn down. That is important, because then
                        // if someone holds a handle to the grouped observable and tries to subscribe to it
                        // after the connection to the source has been severed, they will get an
                        // `ObjectUnsubscribedError` and know they can't possibly get any notifications.
                        group, () => {
                            // Our duration notified! We can complete the group.
                            // The group will be removed from the map in the finalization phase.
                            group.complete();
                            durationSubscriber === null || durationSubscriber === void 0 ? void 0 : durationSubscriber.unsubscribe();
                        }, 
                        // Completions are also sent to the group, but just the group.
                        undefined, 
                        // Errors on the duration subscriber are sent to the group
                        // but only the group. They are not sent to the main subscription.
                        undefined, 
                        // Finalization: Remove this group from our map.
                        () => groups.delete(key));
                        // Start our duration notifier.
                        groupBySourceSubscriber.add(innerFrom(duration(grouped)).subscribe(durationSubscriber));
                    }
                }
                // Send the value to our group.
                group.next(element ? element(value) : value);
            }
            catch (err) {
                handleError(err);
            }
        }, 
        // Source completes.
        () => notify((consumer) => consumer.complete()), 
        // Error from the source.
        handleError, 
        // Free up memory.
        // When the source subscription is _finally_ torn down, release the subjects and keys
        // in our groups Map, they may be quite large and we don't want to keep them around if we
        // don't have to.
        () => groups.clear(), () => {
            teardownAttempted = true;
            // We only kill our subscription to the source if we have
            // no active groups. As stated above, consider this scenario:
            // source$.pipe(groupBy(fn), take(2)).
            return activeGroups === 0;
        });
        // Subscribe to the source
        source.subscribe(groupBySourceSubscriber);
        /**
         * Creates the actual grouped observable returned.
         * @param key The key of the group
         * @param groupSubject The subject that fuels the group
         */
        function createGroupedObservable(key, groupSubject) {
            const result = new Observable((groupSubscriber) => {
                activeGroups++;
                const innerSub = groupSubject.subscribe(groupSubscriber);
                return () => {
                    innerSub.unsubscribe();
                    // We can kill the subscription to our source if we now have no more
                    // active groups subscribed, and a finalization was already attempted on
                    // the source.
                    --activeGroups === 0 && teardownAttempted && groupBySourceSubscriber.unsubscribe();
                };
            });
            result.key = key;
            return result;
        }
    });
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9yeGpzL3NyYy9pbnRlcm5hbC9vcGVyYXRvcnMvZ3JvdXBCeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBRXJDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDdkMsT0FBTyxFQUFFLHdCQUF3QixFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFzSXBGLE9BQU87QUFDUCxNQUFNLFVBQVUsT0FBTyxDQUNyQixXQUE0QixFQUM1QixnQkFBZ0gsRUFDaEgsUUFBeUUsRUFDekUsU0FBa0M7SUFFbEMsT0FBTyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLEVBQUU7UUFDcEMsSUFBSSxPQUFxQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxPQUFPLGdCQUFnQixLQUFLLFVBQVUsRUFBRSxDQUFDO1lBQ2hFLE9BQU8sR0FBRyxnQkFBeUMsQ0FBQztRQUN0RCxDQUFDO2FBQU0sQ0FBQztZQUNOLENBQUMsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLGdCQUFnQixDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUVELCtDQUErQztRQUMvQyxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBdUIsQ0FBQztRQUU5QyxvRUFBb0U7UUFDcEUsTUFBTSxNQUFNLEdBQUcsQ0FBQyxFQUFrQyxFQUFFLEVBQUU7WUFDcEQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNuQixFQUFFLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDakIsQ0FBQyxDQUFDO1FBRUYsMEVBQTBFO1FBQzFFLDZCQUE2QjtRQUM3QixNQUFNLFdB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RSxFQUNwQixHQUFHLEVBQUU7WUFDSCxpQkFBaUIsR0FBRyxJQUFJLENBQUM7WUFDekIseURBQXlEO1lBQ3pELDZEQUE2RDtZQUM3RCxzQ0FBc0M7WUFDdEMsT0FBTyxZQUFZLEtBQUssQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FDRixDQUFDO1FBRUYsMEJBQTBCO1FBQzFCLE1BQU0sQ0FBQyxTQUFTLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUUxQzs7OztXQUlHO1FBQ0gsU0FBUyx1QkFBdUIsQ0FBQyxHQUFNLEVBQUUsWUFBOEI7WUFDckUsTUFBTSxNQUFNLEdBQVEsSUFBSSxVQUFVLENBQUksQ0FBQyxlQUFlLEVBQUUsRUFBRTtnQkFDeEQsWUFBWSxFQUFFLENBQUM7Z0JBQ2YsTUFBTSxRQUFRLEdBQUcsWUFBWSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQztnQkFDekQsT0FBTyxHQUFHLEVBQUU7b0JBQ1YsUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO29CQUN2QixvRUFBb0U7b0JBQ3BFLHdFQUF3RTtvQkFDeEUsY0FBYztvQkFDZCxFQUFFLFlBQVksS0FBSyxDQUFDLElBQUksaUJBQWlCLElBQUksdUJBQXVCLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3JGLENBQUMsQ0FBQztZQUNKLENBQUMsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7WUFDakIsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsImZpbGUiOiJub2RlX21vZHVsZXMvcnhqcy9zcmMvaW50ZXJuYWwvb3BlcmF0b3JzL2dyb3VwQnkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAnLi4vT2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBpbm5lckZyb20gfSBmcm9tICcuLi9vYnNlcnZhYmxlL2lubmVyRnJvbSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAnLi4vU3ViamVjdCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlSW5wdXQsIE9ic2VydmVyLCBPcGVyYXRvckZ1bmN0aW9uLCBTdWJqZWN0TGlrZSB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IG9wZXJhdGUgfSBmcm9tICcuLi91dGlsL2xpZnQnO1xuaW1wb3J0IHsgY3JlYXRlT3BlcmF0b3JTdWJzY3JpYmVyLCBPcGVyYXRvclN1YnNjcmliZXIgfSBmcm9tICcuL09wZXJhdG9yU3Vic2NyaWJlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmFzaWNHcm91cEJ5T3B0aW9uczxLLCBUPiB7XG4gIGVsZW1lbnQ/OiB1bmRlZmluZWQ7XG4gIGR1cmF0aW9uPzogKGdyb3VwZWQ6IEdyb3VwZWRPYnNlcnZhYmxlPEssIFQ+KSA9PiBPYnNlcnZhYmxlSW5wdXQ8YW55PjtcbiAgY29ubmVjdG9yPzogKCkgPT4gU3ViamVjdExpa2U8VD47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR3JvdXBCeU9wdGlvbnNXaXRoRWxlbWVudDxLLCBFLCBUPiB7XG4gIGVsZW1lbnQ6ICh2YWx1ZTogVCkgPT4gRTtcbiAgZHVyYXRpb24/OiAoZ3JvdXBlZDogR3JvdXBlZE9ic2VydmFibGU8SywgRT4pID0+IE9ic2VydmFibGVJbnB1dDxhbnk+O1xuICBjb25uZWN0b3I/OiAoKSA9PiBTdWJqZWN0TGlrZTxFPjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdyb3VwQnk8VCwgSz4oa2V5OiAodmFsdWU6IFQpID0+IEssIG9wdGlvbnM6IEJhc2ljR3JvdXBCeU9wdGlvbnM8SywgVD4pOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEdyb3VwZWRPYnNlcnZhYmxlPEssIFQ+PjtcblxuZXhwb3J0IGZ1bmN0aW9uIGdyb3VwQnk8VCwgSywgRT4oXG4gIGtleTogKHZhbHVlOiBUKSA9PiBLLFxuICBvcHRpb25zOiBHcm91cEJ5T3B0aW9uc1dpdGhFbGVtZW50PEssIEUsIFQ+XG4pOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEdyb3VwZWRPYnNlcnZhYmxlPEssIEU+PjtcblxuZXhwb3J0IGZ1bmN0aW9uIGdyb3VwQnk8VCwgSyBleHRlbmRzIFQ+KFxuICBrZXk6ICh2YWx1ZTogVCkgPT4gdmFsdWUgaXMgS1xuKTogT3BlcmF0b3JGdW5jdGlvbjxULCBHcm91cGVkT2JzZXJ2YWJsZTx0cnVlLCBLPiB8IEdyb3VwZWRPYnNlcnZhYmxlPGZhbHNlLCBFeGNsdWRlPFQsIEs+Pj47XG5cbmV4cG9ydCBmdW5jdGlvbiBncm91cEJ5PFQsIEs+KGtleTogKHZhbHVlOiBUKSA9PiBLKTogT3BlcmF0b3JGdW5jdGlvbjxULCBHcm91cGVkT2JzZXJ2YWJsZTxLLCBUPj47XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgdXNlIHRoZSBvcHRpb25zIHBhcmFtZXRlciBpbnN0ZWFkLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ3JvdXBCeTxULCBLPihcbiAga2V5OiAodmFsdWU6IFQpID0+IEssXG4gIGVsZW1lbnQ6IHZvaWQsXG4gIGR1cmF0aW9uOiAoZ3JvdXBlZDogR3JvdXBlZE9ic2VydmFibGU8SywgVD4pID0+IE9ic2VydmFibGU8YW55PlxuKTogT3BlcmF0b3JGdW5jdGlvbjxULCBHcm91cGVkT2JzZXJ2YWJsZTxLLCBUPj47XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgdXNlIHRoZSBvcHRpb25zIHBhcmFtZXRlciBpbnN0ZWFkLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ3JvdXBCeTxULCBLLCBSPihcbiAga2V5OiAodmFsdWU6IFQpID0+IEssXG4gIGVsZW1lbnQ/OiAodmFsdWU6IFQpID0+IFIsXG4gIGR1cmF0aW9uPzogKGdyb3VwZWQ6IEdyb3VwZWRPYnNlcnZhYmxlPEssIFI+KSA9PiBPYnNlcnZhYmxlPGFueT5cbik6IE9wZXJhdG9yRnVuY3Rpb248VCwgR3JvdXBlZE9ic2VydmFibGU8SywgUj4+O1xuXG4vKipcbiAqIEdyb3VwcyB0aGUgaXRlbXMgZW1pdHRlZCBieSBhbiBPYnNlcnZhYmxlIGFjY29yZGluZyB0byBhIHNwZWNpZmllZCBjcml0ZXJpb24sXG4gKiBhbmQgZW1pdHMgdGhlc2UgZ3JvdXBlZCBpdGVtcyBhcyBgR3JvdXBlZE9ic2VydmFibGVzYCwgb25lXG4gKiB7QGxpbmsgR3JvdXBlZE9ic2VydmFibGV9IHBlciBncm91cC5cbiAqXG4gKiAhW10oZ3JvdXBCeS5wbmcpXG4gKlxuICogV2hlbiB0aGUgT2JzZXJ2YWJsZSBlbWl0cyBhbiBpdGVtLCBhIGtleSBpcyBjb21wdXRlZCBmb3IgdGhpcyBpdGVtIHdpdGggdGhlIGtleSBmdW5jdGlvbi5cbiAqXG4gKiBJZiBhIHtAbGluayBHcm91cGVkT2JzZXJ2YWJsZX0gZm9yIHRoaXMga2V5IGV4aXN0cywgdGhpcyB7QGxpbmsgR3JvdXBlZE9ic2VydmFibGV9IGVtaXRzLiBPdGhlcndpc2UsIGEgbmV3XG4gKiB7QGxpbmsgR3JvdXBlZE9ic2VydmFibGV9IGZvciB0aGlzIGtleSBpcyBjcmVhdGVkIGFuZCBlbWl0cy5cbiAqXG4gKiBBIHtAbGluayBHcm91cGVkT2JzZXJ2YWJsZX0gcmVwcmVzZW50cyB2YWx1ZXMgYmVsb25naW5nIHRvIHRoZSBzYW1lIGdyb3VwIHJlcHJlc2VudGVkIGJ5IGEgY29tbW9uIGtleS4gVGhlIGNvbW1vblxuICoga2V5IGlzIGF2YWlsYWJsZSBhcyB0aGUgYGtleWAgZmllbGQgb2YgYSB7QGxpbmsgR3JvdXBlZE9ic2VydmFibGV9IGluc3RhbmNlLlxuICpcbiAqIFRoZSBlbGVtZW50cyBlbWl0dGVkIGJ5IHtAbGluayBHcm91cGVkT2JzZXJ2YWJsZX1zIGFyZSBieSBkZWZhdWx0IHRoZSBpdGVtcyBlbWl0dGVkIGJ5IHRoZSBPYnNlcnZhYmxlLCBvciBlbGVtZW50c1xuICogcmV0dXJuZWQgYnkgdGhlIGVsZW1lbnQgZnVuY3Rpb24uXG4gKlxuICogIyMgRXhhbXBsZXNcbiAqXG4gKiBHcm91cCBvYmplY3RzIGJ5IGBpZGAgYW5kIHJldHVybiBhcyBhcnJheVxuICpcbiAqIGBgYHRzXG4gKiBpbXBvcnQgeyBvZiwgZ3JvdXBCeSwgbWVyZ2VNYXAsIHJlZHVjZSB9IGZyb20gJ3J4anMnO1xuICpcbiAqIG9mKFxuICogICB7IGlkOiAxLCBuYW1lOiAnSmF2YVNjcmlwdCcgfSxcbiAqICAgeyBpZDogMiwgbmFtZTogJ1BhcmNlbCcgfSxcbiAqICAgeyBpZDogMiwgbmFtZTogJ3dlYnBhY2snIH0sXG4gKiAgIHsgaWQ6IDEsIG5hbWU6ICdUeXBlU2NyaXB0JyB9LFxuICogICB7IGlkOiAzLCBuYW1lOiAnVFNMaW50JyB9XG4gKiApLnBpcGUoXG4gKiAgIGdyb3VwQnkocCA9PiBwLmlkKSxcbiAqICAgbWVyZ2VNYXAoZ3JvdXAkID0+IGdyb3VwJC5waXBlKHJlZHVjZSgoYWNjLCBjdXIpID0+IFsuLi5hY2MsIGN1cl0sIFtdKSkpXG4gKiApXG4gKiAuc3Vic2NyaWJlKHAgPT4gY29uc29sZS5sb2cocCkpO1xuICpcbiAqIC8vIGRpc3BsYXlzOlxuICogLy8gW3sgaWQ6IDEsIG5hbWU6ICdKYXZhU2NyaXB0JyB9LCB7IGlkOiAxLCBuYW1lOiAnVHlwZVNjcmlwdCd9XVxuICogLy8gW3sgaWQ6IDIsIG5hbWU6ICdQYXJjZWwnIH0sIHsgaWQ6IDIsIG5hbWU6ICd3ZWJwYWNrJ31dXG4gKiAvLyBbeyBpZDogMywgbmFtZTogJ1RTTGludCcgfV1cbiAqIGBgYFxuICpcbiAqIFBpdm90IGRhdGEgb24gdGhlIGBpZGAgZmllbGRcbiAqXG4gKiBgYGB0c1xuICogaW1wb3J0IHsgb2YsIGdyb3VwQnksIG1lcmdlTWFwLCByZWR1Y2UsIG1hcCB9IGZyb20gJ3J4anMnO1xuICpcbiAqIG9mKFxuICogICB7IGlkOiAxLCBuYW1lOiAnSmF2YVNjcmlwdCcgfSxcbiAqICAgeyBpZDogMiwgbmFtZTogJ1BhcmNlbCcgfSxcbiAqICAgeyBpZDogMiwgbmFtZTogJ3dlYnBhY2snIH0sXG4gKiAgIHsgaWQ6IDEsIG5hbWU6ICdUeXBlU2NyaXB0JyB9LFxuICogICB7IGlkOiAzLCBuYW1lOiAnVFNMaW50JyB9XG4gKiApLnBpcGUoXG4gKiAgIGdyb3VwQnkocCA9PiBwLmlkLCB7IGVsZW1lbnQ6IHAgPT4gcC5uYW1lIH0pLFxuICogICBtZXJnZU1hcChncm91cCQgPT4gZ3JvdXAkLnBpcGUocmVkdWNlKChhY2MsIGN1cikgPT4gWy4uLmFjYywgY3VyXSwgW2AkeyBncm91cCQua2V5IH1gXSkpKSxcbiAqICAgbWFwKGFyciA9PiAoeyBpZDogcGFyc2VJbnQoYXJyWzBdLCAxMCksIHZhbHVlczogYXJyLnNsaWNlKDEpIH0pKVxuICogKVxuICogLnN1YnNjcmliZShwID0+IGNvbnNvbGUubG9nKHApKTtcbiAqXG4gKiAvLyBkaXNwbGF5czpcbiAqIC8vIHsgaWQ6IDEsIHZhbHVlczogWyAnSmF2YVNjcmlwdCcsICdUeXBlU2NyaXB0JyBdIH1cbiAqIC8vIHsgaWQ6IDIsIHZhbHVlczogWyAnUGFyY2VsJywgJ3dlYnBhY2snIF0gfVxuICogLy8geyBpZDogMywgdmFsdWVzOiBbICdUU0xpbnQnIF0gfVxuICogYGBgXG4gKlxuICogQHBhcmFtIGtleSBBIGZ1bmN0aW9uIHRoYXQgZXh0cmFjdHMgdGhlIGtleVxuICogZm9yIGVhY2ggaXRlbS5cbiAqIEBwYXJhbSBlbGVtZW50IEEgZnVuY3Rpb24gdGhhdCBleHRyYWN0cyB0aGVcbiAqIHJldHVybiBlbGVtZW50IGZvciBlYWNoIGl0ZW0uXG4gKiBAcGFyYW0gZHVyYXRpb25cbiAqIEEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGFuIE9ic2VydmFibGUgdG8gZGV0ZXJtaW5lIGhvdyBsb25nIGVhY2ggZ3JvdXAgc2hvdWxkXG4gKiBleGlzdC5cbiAqIEBwYXJhbSBjb25uZWN0b3IgRmFjdG9yeSBmdW5jdGlvbiB0byBjcmVhdGUgYW5cbiAqIGludGVybWVkaWF0ZSBTdWJqZWN0IHRocm91Z2ggd2hpY2ggZ3JvdXBlZCBlbGVtZW50cyBhcmUgZW1pdHRlZC5cbiAqIEByZXR1cm4gQSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gT2JzZXJ2YWJsZSB0aGF0IGVtaXRzIEdyb3VwZWRPYnNlcnZhYmxlcyxcbiAqIGVhY2ggb2Ygd2hpY2ggY29ycmVzcG9uZHMgdG8gYSB1bmlxdWUga2V5IHZhbHVlIGFuZCBlYWNoIG9mIHdoaWNoIGVtaXRzXG4gKiB0aG9zZSBpdGVtcyBmcm9tIHRoZSBzb3VyY2UgT2JzZXJ2YWJsZSB0aGF0IHNoYXJlIHRoYXQga2V5IHZhbHVlLlxuICpcbiAqIEBkZXByZWNhdGVkIFVzZSB0aGUgb3B0aW9ucyBwYXJhbWV0ZXIgaW5zdGVhZC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdyb3VwQnk8VCwgSywgUj4oXG4gIGtleTogKHZhbHVlOiBUKSA9PiBLLFxuICBlbGVtZW50PzogKHZhbHVlOiBUKSA9PiBSLFxuICBkdXJhdGlvbj86IChncm91cGVkOiBHcm91cGVkT2JzZXJ2YWJsZTxLLCBSPikgPT4gT2JzZXJ2YWJsZTxhbnk+LFxuICBjb25uZWN0b3I/OiAoKSA9PiBTdWJqZWN0PFI+XG4pOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEdyb3VwZWRPYnNlcnZhYmxlPEssIFI+PjtcblxuLy8gSW1wbFxuZXhwb3J0IGZ1bmN0aW9uIGdyb3VwQnk8VCwgSywgUj4oXG4gIGtleVNlbGVjdG9yOiAodmFsdWU6IFQpID0+IEssXG4gIGVsZW1lbnRPck9wdGlvbnM/OiAoKHZhbHVlOiBhbnkpID0+IGFueSkgfCB2b2lkIHwgQmFzaWNHcm91cEJ5T3B0aW9uczxLLCBUPiB8IEdyb3VwQnlPcHRpb25zV2l0aEVsZW1lbnQ8SywgUiwgVD4sXG4gIGR1cmF0aW9uPzogKGdyb3VwZWQ6IEdyb3VwZWRPYnNlcnZhYmxlPGFueSwgYW55PikgPT4gT2JzZXJ2YWJsZUlucHV0PGFueT4sXG4gIGNvbm5lY3Rvcj86ICgpID0+IFN1YmplY3RMaWtlPGFueT5cbik6IE9wZXJhdG9yRnVuY3Rpb248VCwgR3JvdXBlZE9ic2VydmFibGU8SywgUj4+IHtcbiAgcmV0dXJuIG9wZXJhdGUoKHNvdXJjZSwgc3Vic2NyaWJlcikgPT4ge1xuICAgIGxldCBlbGVtZW50OiAoKHZhbHVlOiBhbnkpID0+IGFueSkgfCB2b2lkO1xuICAgIGlmICghZWxlbWVudE9yT3B0aW9ucyB8fCB0eXBlb2YgZWxlbWVudE9yT3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgZWxlbWVudCA9IGVsZW1lbnRPck9wdGlvbnMgYXMgKCh2YWx1ZTogYW55KSA9PiBhbnkpO1xuICAgIH0gZWxzZSB7XG4gICAgICAoeyBkdXJhdGlvbiwgZWxlbWVudCwgY29ubmVjdG9yIH0gPSBlbGVtZW50T3JPcHRpb25zKTtcbiAgICB9XG5cbiAgICAvLyBBIGxvb2t1cCBmb3IgdGhlIGdyb3VwcyB0aGF0IHdlIGhhdmUgc28gZmFyLlxuICAgIGNvbnN0IGdyb3VwcyA9IG5ldyBNYXA8SywgU3ViamVjdExpa2U8YW55Pj4oKTtcblxuICAgIC8vIFVzZWQgZm9yIG5vdGlmeWluZyBhbGwgZ3JvdXBzIGFuZCB0aGUgc3Vic2NyaWJlciBpbiB0aGUgc2FtZSB3YXkuXG4gICAgY29uc3Qgbm90aWZ5ID0gKGNiOiAoZ3JvdXA6IE9ic2VydmVyPGFueT4pID0+IHZvaWQpID0+IHtcbiAgICAgIGdyb3Vwcy5mb3JFYWNoKGNiKTtcbiAgICAgIGNiKHN1YnNjcmliZXIpO1xuICAgIH07XG5cbiAgICAvLyBVc2VkIHRvIGhhbmRsZSBlcnJvcnMgZnJvbSB0aGUgc291cmNlLCBBTkQgZXJyb3JzIHRoYXQgb2NjdXIgZHVyaW5nIHRoZVxuICAgIC8vIG5leHQgY2FsbCBmcm9tIHRoZSBzb3VyY2UuXG4gICAgY29uc3QgaGFuZGxlRXJyb3IgPSAoZXJyOiBhbnkpID0+IG5vdGlmeSgoY29uc3VtZXIpID0+IGNvbnN1bWVyLmVycm9yKGVycikpO1xuXG4gICAgLy8gVGhlIG51bWJlciBvZiBhY3RpdmVseSBzdWJzY3JpYmVkIGdyb3Vwc1xuICAgIGxldCBhY3RpdmVHcm91cHMgPSAwO1xuXG4gICAgLy8gV2hldGhlciBvciBub3QgdGVhcmRvd24gd2FzIGF0dGVtcHRlZCBvbiB0aGlzIHN1YnNjcmlwdGlvbi5cbiAgICBsZXQgdGVhcmRvd25BdHRlbXB0ZWQgPSBmYWxzZTtcblxuICAgIC8vIENhcHR1cmluZyBhIHJlZmVyZW5jZSB0byB0aGlzLCBiZWNhdXNlIHdlIG5lZWQgYSBoYW5kbGUgdG8gaXRcbiAgICAvLyBpbiBgY3JlYXRlR3JvdXBlZE9ic2VydmFibGVgIGJlbG93LiBUaGlzIGlzIHdoYXQgd2UgdXNlIHRvXG4gICAgLy8gc3Vic2NyaWJlIHRvIG91ciBzb3VyY2Ugb2JzZXJ2YWJsZS4gVGhpcyBzb21ldGltZXMgbmVlZHMgdG8gYmUgdW5zdWJzY3JpYmVkXG4gICAgLy8gb3V0LW9mLWJhbmQgd2l0aCBvdXIgYHN1YnNjcmliZXJgIHdoaWNoIGlzIHRoZSBkb3duc3RyZWFtIHN1YnNjcmliZXIsIG9yIGRlc3RpbmF0aW9uLFxuICAgIC8vIGluIGNhc2VzIHdoZXJlIGEgdXNlciB1bnN1YnNjcmliZXMgZnJvbSB0aGUgbWFpbiByZXN1bHRpbmcgc3Vic2NyaXB0aW9uLCBidXRcbiAgICAvLyBzdGlsbCBoYXMgZ3JvdXBzIGZyb20gdGhpcyBzdWJzY3JpcHRpb24gc3Vic2NyaWJlZCBhbmQgd291bGQgZXhwZWN0IHZhbHVlcyBmcm9tIGl0XG4gICAgLy8gQ29uc2lkZXI6ICBgc291cmNlLnBpcGUoZ3JvdXBCeShmbiksIHRha2UoMikpYC5cbiAgICBjb25zdCBncm91cEJ5U291cmNlU3Vic2NyaWJlciA9IG5ldyBPcGVyYXRvclN1YnNjcmliZXIoXG4gICAgICBzdWJzY3JpYmVyLFxuICAgICAgKHZhbHVlOiBUKSA9PiB7XG4gICAgICAgIC8vIEJlY2F1c2Ugd2UgaGF2ZSB0byBub3RpZnkgYWxsIGdyb3VwcyBvZiBhbnkgZXJyb3JzIHRoYXQgb2NjdXIgaW4gaGVyZSxcbiAgICAgICAgLy8gd2UgaGF2ZSB0byBhZGQgb3VyIG93biB0cnkvY2F0Y2ggdG8gZW5zdXJlIHRoYXQgdGhvc2UgZXJyb3JzIGFyZSBwcm9wYWdhdGVkLlxuICAgICAgICAvLyBPcGVyYXRvclN1YnNjcmliZXIgd2lsbCBvbmx5IHNlbmQgdGhlIGVycm9yIHRvIHRoZSBtYWluIHN1YnNjcmliZXIuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3Qga2V5ID0ga2V5U2VsZWN0b3IodmFsdWUpO1xuXG4gICAgICAgICAgbGV0IGdyb3VwID0gZ3JvdXBzLmdldChrZXkpO1xuICAgICAgICAgIGlmICghZ3JvdXApIHtcbiAgICAgICAgICAgIC8vIENyZWF0ZSBvdXIgZ3JvdXAgc3ViamVjdFxuICAgICAgICAgICAgZ3JvdXBzLnNldChrZXksIChncm91cCA9IGNvbm5lY3RvciA/IGNvbm5lY3RvcigpIDogbmV3IFN1YmplY3Q8YW55PigpKSk7XG5cbiAgICAgICAgICAgIC8vIEVtaXQgdGhlIGdyb3VwZWQgb2JzZXJ2YWJsZS4gTm90ZSB0aGF0IHdlIGNhbid0IGRvIGEgc2ltcGxlIGBhc09ic2VydmFibGUoKWAgaGVyZSxcbiAgICAgICAgICAgIC8vIGJlY2F1c2UgdGhlIGdyb3VwZWQgb2JzZXJ2YWJsZSBoYXMgc3BlY2lhbCBzZW1hbnRpY3MgYXJvdW5kIHJlZmVyZW5jZSBjb3VudGluZ1xuICAgICAgICAgICAgLy8gdG8gZW5zdXJlIHdlIGRvbid0IHNldmVyIG91ciBjb25uZWN0aW9uIHRvIHRoZSBzb3VyY2UgcHJlbWF0dXJlbHkuXG4gICAgICAgICAgICBjb25zdCBncm91cGVkID0gY3JlYXRlR3JvdXBlZE9ic2VydmFibGUoa2V5LCBncm91cCk7XG4gICAgICAgICAgICBzdWJzY3JpYmVyLm5leHQoZ3JvdXBlZCk7XG5cbiAgICAgICAgICAgIGlmIChkdXJhdGlvbikge1xuICAgICAgICAgICAgICBjb25zdCBkdXJhdGlvblN1YnNjcmliZXIgPSBjcmVhdGVPcGVyYXRvclN1YnNjcmliZXIoXG4gICAgICAgICAgICAgICAgLy8gUHJvdmlkaW5nIHRoZSBncm91cCBoZXJlIGVuc3VyZXMgdGhhdCBpdCBpcyBkaXNwb3NlZCBvZiAtLSB2aWEgYHVuc3Vic2NyaWJlYCAtLVxuICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhlIGR1cmF0aW9uIHN1YnNjcmlwdGlvbiBpcyB0b3JuIGRvd24uIFRoYXQgaXMgaW1wb3J0YW50LCBiZWNhdXNlIHRoZW5cbiAgICAgICAgICAgICAgICAvLyBpZiBzb21lb25lIGhvbGRzIGEgaGFuZGxlIHRvIHRoZSBncm91cGVkIG9ic2VydmFibGUgYW5kIHRyaWVzIHRvIHN1YnNjcmliZSB0byBpdFxuICAgICAgICAgICAgICAgIC8vIGFmdGVyIHRoZSBjb25uZWN0aW9uIHRvIHRoZSBzb3VyY2UgaGFzIGJlZW4gc2V2ZXJlZCwgdGhleSB3aWxsIGdldCBhblxuICAgICAgICAgICAgICAgIC8vIGBPYmplY3RVbnN1YnNjcmliZWRFcnJvcmAgYW5kIGtub3cgdGhleSBjYW4ndCBwb3NzaWJseSBnZXQgYW55IG5vdGlmaWNhdGlvbnMuXG4gICAgICAgICAgICAgICAgZ3JvdXAgYXMgYW55LFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgIC8vIE91ciBkdXJhdGlvbiBub3RpZmllZCEgV2UgY2FuIGNvbXBsZXRlIHRoZSBncm91cC5cbiAgICAgICAgICAgICAgICAgIC8vIFRoZSBncm91cCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgbWFwIGluIHRoZSBmaW5hbGl6YXRpb24gcGhhc2UuXG4gICAgICAgICAgICAgICAgICBncm91cCEuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICAgIGR1cmF0aW9uU3Vic2NyaWJlcj8udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIC8vIENvbXBsZXRpb25zIGFyZSBhbHNvIHNlbnQgdG8gdGhlIGdyb3VwLCBidXQganVzdCB0aGUgZ3JvdXAuXG4gICAgICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIC8vIEVycm9ycyBvbiB0aGUgZHVyYXRpb24gc3Vic2NyaWJlciBhcmUgc2VudCB0byB0aGUgZ3JvdXBcbiAgICAgICAgICAgICAgICAvLyBidXQgb25seSB0aGUgZ3JvdXAuIFRoZXkgYXJlIG5vdCBzZW50IHRvIHRoZSBtYWluIHN1YnNjcmlwdGlvbi5cbiAgICAgICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgLy8gRmluYWxpemF0aW9uOiBSZW1vdmUgdGhpcyBncm91cCBmcm9tIG91ciBtYXAuXG4gICAgICAgICAgICAgICAgKCkgPT4gZ3JvdXBzLmRlbGV0ZShrZXkpXG4gICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgLy8gU3RhcnQgb3VyIGR1cmF0aW9uIG5vdGlmaWVyLlxuICAgICAgICAgICAgICBncm91cEJ5U291cmNlU3Vic2NyaWJlci5hZGQoaW5uZXJGcm9tKGR1cmF0aW9uKGdyb3VwZWQpKS5zdWJzY3JpYmUoZHVyYXRpb25TdWJzY3JpYmVyKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gU2VuZCB0aGUgdmFsdWUgdG8gb3VyIGdyb3VwLlxuICAgICAgICAgIGdyb3VwLm5leHQoZWxlbWVudCA/IGVsZW1lbnQodmFsdWUpIDogdmFsdWUpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBoYW5kbGVFcnJvcihlcnIpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgLy8gU291cmNlIGNvbXBsZXRlcy5cbiAgICAgICgpID0+IG5vdGlmeSgoY29uc3VtZXIpID0+IGNvbnN1bWVyLmNvbXBsZXRlKCkpLFxuICAgICAgLy8gRXJyb3IgZnJvbSB0aGUgc291cmNlLlxuICAgICAgaGFuZGxlRXJyb3IsXG4gICAgICAvLyBGcmVlIHVwIG1lbW9yeS5cbiAgICAgIC8vIFdoZW4gdGhlIHNvdXJjZSBzdWJzY3JpcHRpb24gaXMgX2ZpbmFsbHlfIHRvcm4gZG93biwgcmVsZWFzZSB0aGUgc3ViamVjdHMgYW5kIGtleXNcbiAgICAgIC8vIGluIG91ciBncm91cHMgTWFwLCB0aGV5IG1heSBiZSBxdWl0ZSBsYXJnZSBhbmQgd2UgZG9uJ3Qgd2FudCB0byBrZWVwIHRoZW0gYXJvdW5kIGlmIHdlXG4gICAgICAvLyBkb24ndCBoYXZlIHRvLlxuICAgICAgKCkgPT4gZ3JvdXBzLmNsZWFyKCksXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHRlYXJkb3duQXR0ZW1wdGVkID0gdHJ1ZTtcbiAgICAgICAgLy8gV2Ugb25seSBraWxsIG91ciBzdWJzY3JpcHRpb24gdG8gdGhlIHNvdXJjZSBpZiB3ZSBoYXZlXG4gICAgICAgIC8vIG5vIGFjdGl2ZSBncm91cHMuIEFzIHN0YXRlZCBhYm92ZSwgY29uc2lkZXIgdGhpcyBzY2VuYXJpbzpcbiAgICAgICAgLy8gc291cmNlJC5waXBlKGdyb3VwQnkoZm4pLCB0YWtlKDIpKS5cbiAgICAgICAgcmV0dXJuIGFjdGl2ZUdyb3VwcyA9PT0gMDtcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gU3Vic2NyaWJlIHRvIHRoZSBzb3VyY2VcbiAgICBzb3VyY2Uuc3Vic2NyaWJlKGdyb3VwQnlTb3VyY2VTdWJzY3JpYmVyKTtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgdGhlIGFjdHVhbCBncm91cGVkIG9ic2VydmFibGUgcmV0dXJuZWQuXG4gICAgICogQHBhcmFtIGtleSBUaGUga2V5IG9mIHRoZSBncm91cFxuICAgICAqIEBwYXJhbSBncm91cFN1YmplY3QgVGhlIHN1YmplY3QgdGhhdCBmdWVscyB0aGUgZ3JvdXBcbiAgICAgKi9cbiAgICBmdW5jdGlvbiBjcmVhdGVHcm91cGVkT2JzZXJ2YWJsZShrZXk6IEssIGdyb3VwU3ViamVjdDogU3ViamVjdExpa2U8YW55Pikge1xuICAgICAgY29uc3QgcmVzdWx0OiBhbnkgPSBuZXcgT2JzZXJ2YWJsZTxUPigoZ3JvdXBTdWJzY3JpYmVyKSA9PiB7XG4gICAgICAgIGFjdGl2ZUdyb3VwcysrO1xuICAgICAgICBjb25zdCBpbm5lclN1YiA9IGdyb3VwU3ViamVjdC5zdWJzY3JpYmUoZ3JvdXBTdWJzY3JpYmVyKTtcbiAgICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgICBpbm5lclN1Yi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgIC8vIFdlIGNhbiBraWxsIHRoZSBzdWJzY3JpcHRpb24gdG8gb3VyIHNvdXJjZSBpZiB3ZSBub3cgaGF2ZSBubyBtb3JlXG4gICAgICAgICAgLy8gYWN0aXZlIGdyb3VwcyBzdWJzY3JpYmVkLCBhbmQgYSBmaW5hbGl6YXRpb24gd2FzIGFscmVhZHkgYXR0ZW1wdGVkIG9uXG4gICAgICAgICAgLy8gdGhlIHNvdXJjZS5cbiAgICAgICAgICAtLWFjdGl2ZUdyb3VwcyA9PT0gMCAmJiB0ZWFyZG93bkF0dGVtcHRlZCAmJiBncm91cEJ5U291cmNlU3Vic2NyaWJlci51bnN1YnNjcmliZSgpO1xuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgICByZXN1bHQua2V5ID0ga2V5O1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gIH0pO1xufVxuXG4vKipcbiAqIEFuIG9ic2VydmFibGUgb2YgdmFsdWVzIHRoYXQgaXMgdGhlIGVtaXR0ZWQgYnkgdGhlIHJlc3VsdCBvZiBhIHtAbGluayBncm91cEJ5fSBvcGVyYXRvcixcbiAqIGNvbnRhaW5zIGEgYGtleWAgcHJvcGVydHkgZm9yIHRoZSBncm91cGluZy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBHcm91cGVkT2JzZXJ2YWJsZTxLLCBUPiBleHRlbmRzIE9ic2VydmFibGU8VD4ge1xuICAvKipcbiAgICogVGhlIGtleSB2YWx1ZSBmb3IgdGhlIGdyb3VwZWQgbm90aWZpY2F0aW9ucy5cbiAgICovXG4gIHJlYWRvbmx5IGtleTogSztcbn1cbiJdfQ==
