import { Subject, AnonymousSubject } from '../../Subject.mjs';
import { Subscriber } from '../../Subscriber.mjs';
import { Observable } from '../../Observable.mjs';
import { Subscription } from '../../Subscription.mjs';
import { ReplaySubject } from '../../ReplaySubject.mjs';
const DEFAULT_WEBSOCKET_CONFIG = {
    url: '',
    deserializer: (e) => JSON.parse(e.data),
    serializer: (value) => JSON.stringify(value),
};
const WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT = 'WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }';
export class WebSocketSubject extends AnonymousSubject {
    constructor(urlConfigOrSource, destination) {
        super();
        this._socket = null;
        if (urlConfigOrSource instanceof Observable) {
            this.destination = destination;
            this.source = urlConfigOrSource;
        }
        else {
            const config = (this._config = Object.assign({}, DEFAULT_WEBSOCKET_CONFIG));
            this._output = new Subject();
            if (typeof urlConfigOrSource === 'string') {
                config.url = urlConfigOrSource;
            }
            else {
                for (const key in urlConfigOrSource) {
                    if (urlConfigOrSource.hasOwnProperty(key)) {
                        config[key] = urlConfigOrSource[key];
                    }
                }
            }
            if (!config.WebSocketCtor && WebSocket) {
                config.WebSocketCtor = WebSocket;
            }
            else if (!config.WebSocketCtor) {
                throw new Error('no WebSocket constructor can be found');
            }
            this.destination = new ReplaySubject();
        }
    }
    /** @deprecated Internal implementation detail, do not use directly. Will be made internal in v8. */
    lift(operator) {
        const sock = new WebSocketSubject(this._config, this.destination);
        sock.operator = operator;
        sock.source = this;
        return sock;
    }
    _resetState() {
        this._socket = null;
        if (!this.source) {
            this.destination = new ReplaySubject();
        }
        this._output = new Subject();
    }
    /**
     * Creates an {@link Observable}, that when subscribed to, sends a message,
     * defined by the `subMsg` function, to the server over the socket to begin a
     * subscription to data over that socket. Once data arrives, the
     * `messageFilter` argument will be used to select the appropriate data for
     * the resulting Observable. When finalization occurs, either due to
     * unsubscription, completion, or error, a message defined by the `unsubMsg`
     * argument will be sent to the server over the WebSocketSubject.
     *
     * @param subMsg A function to generate the subscription message to be sent to
     * the server. This will still be processed by the serializer in the
     * WebSocketSubject's config. (Which defaults to JSON serialization)
     * @param unsubMsg A function to generate the unsubscription message to be
     * sent to the server at finalization. This will still be processed by the
     * serializer in the WebSocketSubject's config.
     * @param messageFilter A predicate for selecting the appropriate messages
     * from the server for the output stream.
     */
    multiplex(subMsg, unsubMsg, messageFilter) {
        const self = this;
        return new Observable((observer) => {
            try {
                self.next(subMsg());
            }
            catch (err) {
                observer.error(err);
            }
            const subscription = self.subscribe({
                next: (x) => {
                    try {
                        if (messageFilter(x)) {
                            observer.next(x);
                        }
                    }
                    catch (err) {
                        observer.error(err);
                    }
                },
                error: (err) => observer.error(err),
                complete: () => observer.complete(),
            });
            return () => {
                try {
                    self.next(unsubMsg());
                }
                catch (err) {
                    observer.error(err);
                }
                subscription.unsubscribe();
            };
        });
    }
    _connectSocket() {
        const { WebSocketCtor, protocol, url, binaryType } = this._config;
        const observer = this._output;
        let socket = null;
        try {
            socket = protocol ? new WebSocketCtor(url, protocol) : new WebSocketCtor(url);
            this._socket = socket;
            if (binaryType) {
                this._socket.binaryType = binaryType;
            }
        }
        catch (e) {
            observer.error(e);
            return;
        }
        const subscription = new Subscription(() => {
            this._socket = null;
            if (socket && socket.readyState === 1) {
                socket.close();
            }
        });
        socket.onopen = (evt) => {
            const { _socket } = this;
            if (!_socket) {
                socket.close();
                this._resetState();
                return;
            }
            const { openObserver } = this._config;
            if (openObserver) {
                openObserver.next(evt);
            }
            const queue = this.destination;
            this.destination = Subscriber.create((x) => {
                if (socket.readyState === 1) {
                    try {
                        const { serializer } = this._config;
                        socket.send(serializer(x));
                    }
                    catch (e) {
                        this.destination.error(e);
                    }
                }
            }, (err) => {
                const { closingObserver } = this._config;
                if (closingObserver) {
                    closingObserver.next(undefined);
                }
                if (err && err.code) {
                    socket.close(err.code, err.reason);
                }
                else {
                    observer.error(new TypeError(WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT));
                }
                this._resetState();
            }, () => {
                const { closingObserver } = this._config;
                if (closingObserver) {
                    closingObserver.next(undefined);
                }
                socket.close();
                this._resetState();
            });
            if (queue && queue instanceof ReplaySubject) {
                subscription.add(queue.subscribe(this.destination));
            }
        };
        socket.onerror = (e) => {
            this._resetState();
            observer.error(e);
        };
        socket.onclose = (e) => {
            if (socket === this._socket) {
                this._resetState();
            }
            const { closeObserver } = this._config;
            if (closeObserver) {
                closeObserver.next(e);
            }
            if (e.wasClean) {
                observer.complete();
            }
            else {
                observer.error(e);
            }
        };
        socket.onmessage = (e) => {
            try {
                const { deserializer } = this._config;
                observer.next(deserializer(e));
            }
            catch (err) {
                observer.error(err);
            }
        };
    }
    /** @internal */
    _subscribe(subscriber) {
        const { source } = this;
        if (source) {
            return source.subscribe(subscriber);
        }
        if (!this._socket) {
            this._connectSocket();
        }
        this._output.subscribe(subscriber);
        subscriber.add(() => {
            const { _socket } = this;
            if (this._output.observers.length === 0) {
                if (_socket && (_socket.readyState === 1 || _socket.readyState === 0)) {
                    _socket.close();
                }
                this._resetState();
            }
        });
        return subscriber;
    }
    unsubscribe() {
        const { _socket } = this;
        if (_socket && (_socket.readyState === 1 || _socket.readyState === 0)) {
            _socket.close();
        }
        this._resetState();
        super.unsubscribe();
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9yeGpzL3NyYy9pbnRlcm5hbC9vYnNlcnZhYmxlL2RvbS9XZWJTb2NrZXRTdWJqZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFbEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBNElwRCxNQUFNLHdCQUF3QixHQUFnQztJQUM1RCxHQUFHLEVBQUUsRUFBRTtJQUNQLFlBQVksRUFBRSxDQUFDLENBQWUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ3JELFVBQVUsRUFBRSxDQUFDLEtBQVUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUM7Q0FDbEQsQ0FBQztBQUVGLE1BQU0scUNBQXFDLEdBQ3pDLG1JQUFtSSxDQUFDO0FBSXRJLE1BQU0sT0FBTyxnQkFBb0IsU0FBUSxnQkFBbUI7SUFVMUQsWUFBWSxpQkFBcUUsRUFBRSxXQUF5QjtRQUMxRyxLQUFLLEVBQUUsQ0FBQztRQUhGLFlBQU8sR0FBcUIsSUFBSSxDQUFDO1FBSXZDLElBQUksaUJBQWlCLFlBQVksVUFBVSxFQUFFLENBQUM7WUFDNUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7WUFDL0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxpQkFBa0MsQ0FBQztRQUNuRCxDQUFDO2FBQU0sQ0FBQztZQUNOLE1BQU0sTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8scUJBQVEsd0JBQXdCLENBQUUsQ0FBQyxDQUFDO1lBQ2hF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QUUsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDO1lBQ3pCLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUN4QyxJQUFJLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEtBQUssQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFVLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQztvQkFDdEUsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNsQixDQUFDO2dCQUNELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNyQixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBRUQsV0FBVztRQUNULE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDekIsSUFBSSxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxLQUFLLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBVSxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDdEUsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2xCLENBQUM7UUFDRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkIsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3RCLENBQUM7Q0FDRiIsImZpbGUiOiJub2RlX21vZHVsZXMvcnhqcy9zcmMvaW50ZXJuYWwvb2JzZXJ2YWJsZS9kb20vV2ViU29ja2V0U3ViamVjdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QsIEFub255bW91c1N1YmplY3QgfSBmcm9tICcuLi8uLi9TdWJqZWN0JztcbmltcG9ydCB7IFN1YnNjcmliZXIgfSBmcm9tICcuLi8uLi9TdWJzY3JpYmVyJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICcuLi8uLi9PYnNlcnZhYmxlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJy4uLy4uL1N1YnNjcmlwdGlvbic7XG5pbXBvcnQgeyBPcGVyYXRvciB9IGZyb20gJy4uLy4uL09wZXJhdG9yJztcbmltcG9ydCB7IFJlcGxheVN1YmplY3QgfSBmcm9tICcuLi8uLi9SZXBsYXlTdWJqZWN0JztcbmltcG9ydCB7IE9ic2VydmVyLCBOZXh0T2JzZXJ2ZXIgfSBmcm9tICcuLi8uLi90eXBlcyc7XG5cbi8qKlxuICogV2ViU29ja2V0U3ViamVjdENvbmZpZyBpcyBhIHBsYWluIE9iamVjdCB0aGF0IGFsbG93cyB1cyB0byBtYWtlIG91clxuICogd2ViU29ja2V0IGNvbmZpZ3VyYWJsZS5cbiAqXG4gKiA8c3BhbiBjbGFzcz1cImluZm9ybWFsXCI+UHJvdmlkZXMgZmxleGliaWxpdHkgdG8ge0BsaW5rIHdlYlNvY2tldH08L3NwYW4+XG4gKlxuICogSXQgZGVmaW5lcyBhIHNldCBvZiBwcm9wZXJ0aWVzIHRvIHByb3ZpZGUgY3VzdG9tIGJlaGF2aW9yIGluIHNwZWNpZmljXG4gKiBtb21lbnRzIG9mIHRoZSBzb2NrZXQncyBsaWZlY3ljbGUuIFdoZW4gdGhlIGNvbm5lY3Rpb24gb3BlbnMgd2UgY2FuXG4gKiB1c2UgYG9wZW5PYnNlcnZlcmAsIHdoZW4gdGhlIGNvbm5lY3Rpb24gaXMgY2xvc2VkIGBjbG9zZU9ic2VydmVyYCwgaWYgd2VcbiAqIGFyZSBpbnRlcmVzdGVkIGluIGxpc3RlbmluZyBmb3IgZGF0YSBjb21pbmcgZnJvbSBzZXJ2ZXI6IGBkZXNlcmlhbGl6ZXJgLFxuICogd2hpY2ggYWxsb3dzIHVzIHRvIGN1c3RvbWl6ZSB0aGUgZGVzZXJpYWxpemF0aW9uIHN0cmF0ZWd5IG9mIGRhdGEgYmVmb3JlIHBhc3NpbmcgaXRcbiAqIHRvIHRoZSBzb2NrZXQgY2xpZW50LiBCeSBkZWZhdWx0LCBgZGVzZXJpYWxpemVyYCBpcyBnb2luZyB0byBhcHBseSBgSlNPTi5wYXJzZWAgdG8gZWFjaCBtZXNzYWdlIGNvbWluZ1xuICogZnJvbSB0aGUgU2VydmVyLlxuICpcbiAqICMjIEV4YW1wbGVzXG4gKlxuICogKipkZXNlcmlhbGl6ZXIqKiwgdGhlIGRlZmF1bHQgZm9yIHRoaXMgcHJvcGVydHkgaXMgYEpTT04ucGFyc2VgIGJ1dCBzaW5jZSB0aGVyZSBhcmUganVzdCB0d28gb3B0aW9uc1xuICogZm9yIGluY29taW5nIGRhdGEsIGVpdGhlciBiZSB0ZXh0IG9yIGJpbmFyeSBkYXRhLiBXZSBjYW4gYXBwbHkgYSBjdXN0b20gZGVzZXJpYWxpemF0aW9uIHN0cmF0ZWd5XG4gKiBvciBqdXN0IHNpbXBseSBza2lwIHRoZSBkZWZhdWx0IGJlaGF2aW91ci5cbiAqXG4gKiBgYGB0c1xuICogaW1wb3J0IHsgd2ViU29ja2V0IH0gZnJvbSAncnhqcy93ZWJTb2NrZXQnO1xuICpcbiAqIGNvbnN0IHdzU3ViamVjdCA9IHdlYlNvY2tldCh7XG4gKiAgIHVybDogJ3dzOi8vbG9jYWxob3N0OjgwODEnLFxuICogICAvL0FwcGx5IGFueSB0cmFuc2Zvcm1hdGlvbiBvZiB5b3VyIGNob2ljZS5cbiAqICAgZGVzZXJpYWxpemVyOiAoeyBkYXRhIH0pID0+IGRhdGFcbiAqIH0pO1xuICpcbiAqIHdzU3ViamVjdC5zdWJzY3JpYmUoY29uc29sZS5sb2cpO1xuICpcbiAqIC8vIExldCdzIHN1cHBvc2Ugd2UgaGF2ZSB0aGlzIG9uIHRoZSBTZXJ2ZXI6IHdzLnNlbmQoJ1RoaXMgaXMgYSBtc2cgZnJvbSB0aGUgc2VydmVyJylcbiAqIC8vb3V0cHV0XG4gKiAvL1xuICogLy8gVGhpcyBpcyBhIG1zZyBmcm9tIHRoZSBzZXJ2ZXJcbiAqIGBgYFxuICpcbiAqICoqc2VyaWFsaXplcioqIGFsbG93cyB1cyB0byBhcHBseSBjdXN0b20gc2VyaWFsaXphdGlvbiBzdHJhdGVneSBidXQgZm9yIHRoZSBvdXRnb2luZyBtZXNzYWdlcy5cbiAqXG4gKiBgYGB0c1xuICogaW1wb3J0IHsgd2ViU29ja2V0IH0gZnJvbSAncnhqcy93ZWJTb2NrZXQnO1xuICpcbiAqIGNvbnN0IHdzU3ViamVjdCA9IHdlYlNvY2tldCh7XG4gKiAgIHVybDogJ3dzOi8vbG9jYWxob3N0OjgwODEnLFxuICogICAvLyBBcHBseSBhbnkgdHJhbnNmb3JtYXRpb24gb2YgeW91ciBjaG9pY2UuXG4gKiAgIHNlcmlhbGl6ZXI6IG1zZyA9PiBKU09OLnN0cmluZ2lmeSh7IGNoYW5uZWw6ICd3ZWJEZXZlbG9wbWVudCcsIG1zZzogbXNnIH0pXG4gKiB9KTtcbiAqXG4gKiB3c1N1YmplY3Quc3Vic2NyaWJlKCgpID0+IHN1YmplY3QubmV4dCgnbXNnIHRvIHRoZSBzZXJ2ZXInKSk7XG4gKlxuICogLy8gTGV0J3Mgc3VwcG9zZSB3ZSBoYXZlIHRoaXMgb24gdGhlIFNlcnZlcjpcbiAqIC8vICAgd3Mub24oJ21lc3NhZ2UnLCBtc2cgPT4gY29uc29sZS5sb2cpO1xuICogLy8gICB3cy5zZW5kKCdUaGlzIGlzIGEgbXNnIGZyb20gdGhlIHNlcnZlcicpO1xuICogLy8gb3V0cHV0IGF0IHNlcnZlciBzaWRlOlxuICogLy9cbiAqIC8vIHtcImNoYW5uZWxcIjpcIndlYkRldmVsb3BtZW50XCIsXCJtc2dcIjpcIm1zZyB0byB0aGUgc2VydmVyXCJ9XG4gKiBgYGBcbiAqXG4gKiAqKmNsb3NlT2JzZXJ2ZXIqKiBhbGxvd3MgdXMgdG8gc2V0IGEgY3VzdG9tIGVycm9yIHdoZW4gYW4gZXJyb3IgcmFpc2VzIHVwLlxuICpcbiAqIGBgYHRzXG4gKiBpbXBvcnQgeyB3ZWJTb2NrZXQgfSBmcm9tICdyeGpzL3dlYlNvY2tldCc7XG4gKlxuICogY29uc3Qgd3NTdWJqZWN0ID0gd2ViU29ja2V0KHtcbiAqICAgdXJsOiAnd3M6Ly9sb2NhbGhvc3Q6ODA4MScsXG4gKiAgIGNsb3NlT2JzZXJ2ZXI6IHtcbiAqICAgICBuZXh0KCkge1xuICogICAgICAgY29uc3QgY3VzdG9tRXJyb3IgPSB7IGNvZGU6IDY2NjYsIHJlYXNvbjogJ0N1c3RvbSBldmlsIHJlYXNvbicgfVxuICogICAgICAgY29uc29sZS5sb2coYGNvZGU6ICR7IGN1c3RvbUVycm9yLmNvZGUgfSwgcmVhc29uOiAkeyBjdXN0b21FcnJvci5yZWFzb24gfWApO1xuICogICAgIH1cbiAqICAgfVxuICogfSk7XG4gKlxuICogLy8gb3V0cHV0XG4gKiAvLyBjb2RlOiA2NjY2LCByZWFzb246IEN1c3RvbSBldmlsIHJlYXNvblxuICogYGBgXG4gKlxuICogKipvcGVuT2JzZXJ2ZXIqKiwgTGV0J3Mgc2F5IHdlIG5lZWQgdG8gbWFrZSBzb21lIGtpbmQgb2YgaW5pdCB0YXNrIGJlZm9yZSBzZW5kaW5nL3JlY2VpdmluZyBtc2dzIHRvIHRoZVxuICogd2ViU29ja2V0IG9yIHNlbmRpbmcgbm90aWZpY2F0aW9uIHRoYXQgdGhlIGNvbm5lY3Rpb24gd2FzIHN1Y2Nlc3NmdWwsIHRoaXMgaXMgd2hlblxuICogb3Blbk9ic2VydmVyIGlzIHVzZWZ1bCBmb3IuXG4gKlxuICogYGBgdHNcbiAqIGltcG9ydCB7IHdlYlNvY2tldCB9IGZyb20gJ3J4anMvd2ViU29ja2V0JztcbiAqXG4gKiBjb25zdCB3c1N1YmplY3QgPSB3ZWJTb2NrZXQoe1xuICogICB1cmw6ICd3czovL2xvY2FsaG9zdDo4MDgxJyxcbiAqICAgb3Blbk9ic2VydmVyOiB7XG4gKiAgICAgbmV4dDogKCkgPT4ge1xuICogICAgICAgY29uc29sZS5sb2coJ0Nvbm5lY3Rpb24gb2snKTtcbiAqICAgICB9XG4gKiAgIH1cbiAqIH0pO1xuICpcbiAqIC8vIG91dHB1dFxuICogLy8gQ29ubmVjdGlvbiBva1xuICogYGBgXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgV2ViU29ja2V0U3ViamVjdENvbmZpZzxUPiB7XG4gIC8qKiBUaGUgdXJsIG9mIHRoZSBzb2NrZXQgc2VydmVyIHRvIGNvbm5lY3QgdG8gKi9cbiAgdXJsOiBzdHJpbmc7XG4gIC8qKiBUaGUgcHJvdG9jb2wgdG8gdXNlIHRvIGNvbm5lY3QgKi9cbiAgcHJvdG9jb2w/OiBzdHJpbmcgfCBBcnJheTxzdHJpbmc+O1xuICAvKiogQGRlcHJlY2F0ZWQgV2lsbCBiZSByZW1vdmVkIGluIHY4LiBVc2Uge0BsaW5rIGRlc2VyaWFsaXplcn0gaW5zdGVhZC4gKi9cbiAgcmVzdWx0U2VsZWN0b3I/OiAoZTogTWVzc2FnZUV2ZW50KSA9PiBUO1xuICAvKipcbiAgICogQSBzZXJpYWxpemVyIHVzZWQgdG8gY3JlYXRlIG1lc3NhZ2VzIGZyb20gcGFzc2VkIHZhbHVlcyBiZWZvcmUgdGhlXG4gICAqIG1lc3NhZ2VzIGFyZSBzZW50IHRvIHRoZSBzZXJ2ZXIuIERlZmF1bHRzIHRvIEpTT04uc3RyaW5naWZ5LlxuICAgKi9cbiAgc2VyaWFsaXplcj86ICh2YWx1ZTogVCkgPT4gV2ViU29ja2V0TWVzc2FnZTtcbiAgLyoqXG4gICAqIEEgZGVzZXJpYWxpemVyIHVzZWQgZm9yIG1lc3NhZ2VzIGFycml2aW5nIG9uIHRoZSBzb2NrZXQgZnJvbSB0aGVcbiAgICogc2VydmVyLiBEZWZhdWx0cyB0byBKU09OLnBhcnNlLlxuICAgKi9cbiAgZGVzZXJpYWxpemVyPzogKGU6IE1lc3NhZ2VFdmVudCkgPT4gVDtcbiAgLyoqXG4gICAqIEFuIE9ic2VydmVyIHRoYXQgd2F0Y2hlcyB3aGVuIG9wZW4gZXZlbnRzIG9jY3VyIG9uIHRoZSB1bmRlcmx5aW5nIHdlYiBzb2NrZXQuXG4gICAqL1xuICBvcGVuT2JzZXJ2ZXI/OiBOZXh0T2JzZXJ2ZXI8RXZlbnQ+O1xuICAvKipcbiAgICogQW4gT2JzZXJ2ZXIgdGhhdCB3YXRjaGVzIHdoZW4gY2xvc2UgZXZlbnRzIG9jY3VyIG9uIHRoZSB1bmRlcmx5aW5nIHdlYiBzb2NrZXRcbiAgICovXG4gIGNsb3NlT2JzZXJ2ZXI/OiBOZXh0T2JzZXJ2ZXI8Q2xvc2VFdmVudD47XG4gIC8qKlxuICAgKiBBbiBPYnNlcnZlciB0aGF0IHdhdGNoZXMgd2hlbiBhIGNsb3NlIGlzIGFib3V0IHRvIG9jY3VyIGR1ZSB0b1xuICAgKiB1bnN1YnNjcmlwdGlvbi5cbiAgICovXG4gIGNsb3NpbmdPYnNlcnZlcj86IE5leHRPYnNlcnZlcjx2b2lkPjtcbiAgLyoqXG4gICAqIEEgV2ViU29ja2V0IGNvbnN0cnVjdG9yIHRvIHVzZS4gVGhpcyBpcyB1c2VmdWwgZm9yIHNpdHVhdGlvbnMgbGlrZSB1c2luZyBhXG4gICAqIFdlYlNvY2tldCBpbXBsIGluIE5vZGUgKFdlYlNvY2tldCBpcyBhIERPTSBBUEkpLCBvciBmb3IgbW9ja2luZyBhIFdlYlNvY2tldFxuICAgKiBmb3IgdGVzdGluZyBwdXJwb3Nlc1xuICAgKi9cbiAgV2ViU29ja2V0Q3Rvcj86IHsgbmV3ICh1cmw6IHN0cmluZywgcHJvdG9jb2xzPzogc3RyaW5nIHwgc3RyaW5nW10pOiBXZWJTb2NrZXQgfTtcbiAgLyoqIFNldHMgdGhlIGBiaW5hcnlUeXBlYCBwcm9wZXJ0eSBvZiB0aGUgdW5kZXJseWluZyBXZWJTb2NrZXQuICovXG4gIGJpbmFyeVR5cGU/OiAnYmxvYicgfCAnYXJyYXlidWZmZXInO1xufVxuXG5jb25zdCBERUZBVUxUX1dFQlNPQ0tFVF9DT05GSUc6IFdlYlNvY2tldFN1YmplY3RDb25maWc8YW55PiA9IHtcbiAgdXJsOiAnJyxcbiAgZGVzZXJpYWxpemVyOiAoZTogTWVzc2FnZUV2ZW50KSA9PiBKU09OLnBhcnNlKGUuZGF0YSksXG4gIHNlcmlhbGl6ZXI6ICh2YWx1ZTogYW55KSA9PiBKU09OLnN0cmluZ2lmeSh2YWx1ZSksXG59O1xuXG5jb25zdCBXRUJTT0NLRVRTVUJKRUNUX0lOVkFMSURfRVJST1JfT0JKRUNUID1cbiAgJ1dlYlNvY2tldFN1YmplY3QuZXJyb3IgbXVzdCBiZSBjYWxsZWQgd2l0aCBhbiBvYmplY3Qgd2l0aCBhbiBlcnJvciBjb2RlLCBhbmQgYW4gb3B0aW9uYWwgcmVhc29uOiB7IGNvZGU6IG51bWJlciwgcmVhc29uOiBzdHJpbmcgfSc7XG5cbmV4cG9ydCB0eXBlIFdlYlNvY2tldE1lc3NhZ2UgPSBzdHJpbmcgfCBBcnJheUJ1ZmZlciB8IEJsb2IgfCBBcnJheUJ1ZmZlclZpZXc7XG5cbmV4cG9ydCBjbGFzcyBXZWJTb2NrZXRTdWJqZWN0PFQ+IGV4dGVuZHMgQW5vbnltb3VzU3ViamVjdDxUPiB7XG4gIC8vIEB0cy1pZ25vcmU6IFByb3BlcnR5IGhhcyBubyBpbml0aWFsaXplciBhbmQgaXMgbm90IGRlZmluaXRlbHkgYXNzaWduZWRcbiAgcHJpdmF0ZSBfY29uZmlnOiBXZWJTb2NrZXRTdWJqZWN0Q29uZmlnPFQ+O1xuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgLy8gQHRzLWlnbm9yZTogUHJvcGVydHkgaGFzIG5vIGluaXRpYWxpemVyIGFuZCBpcyBub3QgZGVmaW5pdGVseSBhc3NpZ25lZFxuICBfb3V0cHV0OiBTdWJqZWN0PFQ+O1xuXG4gIHByaXZhdGUgX3NvY2tldDogV2ViU29ja2V0IHwgbnVsbCA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IodXJsQ29uZmlnT3JTb3VyY2U6IHN0cmluZyB8IFdlYlNvY2tldFN1YmplY3RDb25maWc8VD4gfCBPYnNlcnZhYmxlPFQ+LCBkZXN0aW5hdGlvbj86IE9ic2VydmVyPFQ+KSB7XG4gICAgc3VwZXIoKTtcbiAgICBpZiAodXJsQ29uZmlnT3JTb3VyY2UgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSB7XG4gICAgICB0aGlzLmRlc3RpbmF0aW9uID0gZGVzdGluYXRpb247XG4gICAgICB0aGlzLnNvdXJjZSA9IHVybENvbmZpZ09yU291cmNlIGFzIE9ic2VydmFibGU8VD47XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGNvbmZpZyA9ICh0aGlzLl9jb25maWcgPSB7IC4uLkRFRkFVTFRfV0VCU09DS0VUX0NPTkZJRyB9KTtcbiAgICAgIHRoaXMuX291dHB1dCA9IG5ldyBTdWJqZWN0PFQ+KCk7XG4gICAgICBpZiAodHlwZW9mIHVybENvbmZpZ09yU291cmNlID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25maWcudXJsID0gdXJsQ29uZmlnT3JTb3VyY2U7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB1cmxDb25maWdPclNvdXJjZSkge1xuICAgICAgICAgIGlmICh1cmxDb25maWdPclNvdXJjZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAoY29uZmlnIGFzIGFueSlba2V5XSA9ICh1cmxDb25maWdPclNvdXJjZSBhcyBhbnkpW2tleV07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICghY29uZmlnLldlYlNvY2tldEN0b3IgJiYgV2ViU29ja2V0KSB7XG4gICAgICAgIGNvbmZpZy5XZWJTb2NrZXRDdG9yID0gV2ViU29ja2V0O1xuICAgICAgfSBlbHNlIGlmICghY29uZmlnLldlYlNvY2tldEN0b3IpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdubyBXZWJTb2NrZXQgY29uc3RydWN0b3IgY2FuIGJlIGZvdW5kJyk7XG4gICAgICB9XG4gICAgICB0aGlzLmRlc3RpbmF0aW9uID0gbmV3IFJlcGxheVN1YmplY3QoKTtcbiAgICB9XG4gIH1cblxuICAvKiogQGRlcHJlY2F0ZWQgSW50ZXJuYWwgaW1wbGVtZW50YXRpb24gZGV0YWlsLCBkbyBub3QgdXNlIGRpcmVjdGx5LiBXaWxsIGJlIG1hZGUgaW50ZXJuYWwgaW4gdjguICovXG4gIGxpZnQ8Uj4ob3BlcmF0b3I6IE9wZXJhdG9yPFQsIFI+KTogV2ViU29ja2V0U3ViamVjdDxSPiB7XG4gICAgY29uc3Qgc29jayA9IG5ldyBXZWJTb2NrZXRTdWJqZWN0PFI+KHRoaXMuX2NvbmZpZyBhcyBXZWJTb2NrZXRTdWJqZWN0Q29uZmlnPGFueT4sIHRoaXMuZGVzdGluYXRpb24gYXMgYW55KTtcbiAgICBzb2NrLm9wZXJhdG9yID0gb3BlcmF0b3I7XG4gICAgc29jay5zb3VyY2UgPSB0aGlzO1xuICAgIHJldHVybiBzb2NrO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVzZXRTdGF0ZSgpIHtcbiAgICB0aGlzLl9zb2NrZXQgPSBudWxsO1xuICAgIGlmICghdGhpcy5zb3VyY2UpIHtcbiAgICAgIHRoaXMuZGVzdGluYXRpb24gPSBuZXcgUmVwbGF5U3ViamVjdCgpO1xuICAgIH1cbiAgICB0aGlzLl9vdXRwdXQgPSBuZXcgU3ViamVjdDxUPigpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4ge0BsaW5rIE9ic2VydmFibGV9LCB0aGF0IHdoZW4gc3Vic2NyaWJlZCB0bywgc2VuZHMgYSBtZXNzYWdlLFxuICAgKiBkZWZpbmVkIGJ5IHRoZSBgc3ViTXNnYCBmdW5jdGlvbiwgdG8gdGhlIHNlcnZlciBvdmVyIHRoZSBzb2NrZXQgdG8gYmVnaW4gYVxuICAgKiBzdWJzY3JpcHRpb24gdG8gZGF0YSBvdmVyIHRoYXQgc29ja2V0LiBPbmNlIGRhdGEgYXJyaXZlcywgdGhlXG4gICAqIGBtZXNzYWdlRmlsdGVyYCBhcmd1bWVudCB3aWxsIGJlIHVzZWQgdG8gc2VsZWN0IHRoZSBhcHByb3ByaWF0ZSBkYXRhIGZvclxuICAgKiB0aGUgcmVzdWx0aW5nIE9ic2VydmFibGUuIFdoZW4gZmluYWxpemF0aW9uIG9jY3VycywgZWl0aGVyIGR1ZSB0b1xuICAgKiB1bnN1YnNjcmlwdGlvbiwgY29tcGxldGlvbiwgb3IgZXJyb3IsIGEgbWVzc2FnZSBkZWZpbmVkIGJ5IHRoZSBgdW5zdWJNc2dgXG4gICAqIGFyZ3VtZW50IHdpbGwgYmUgc2VudCB0byB0aGUgc2VydmVyIG92ZXIgdGhlIFdlYlNvY2tldFN1YmplY3QuXG4gICAqXG4gICAqIEBwYXJhbSBzdWJNc2cgQSBmdW5jdGlvbiB0byBnZW5lcmF0ZSB0aGUgc3Vic2NyaXB0aW9uIG1lc3NhZ2UgdG8gYmUgc2VudCB0b1xuICAgKiB0aGUgc2VydmVyLiBUaGlzIHdpbGwgc3RpbGwgYmUgcHJvY2Vzc2VkIGJ5IHRoZSBzZXJpYWxpemVyIGluIHRoZVxuICAgKiBXZWJTb2NrZXRTdWJqZWN0J3MgY29uZmlnLiAoV2hpY2ggZGVmYXVsdHMgdG8gSlNPTiBzZXJpYWxpemF0aW9uKVxuICAgKiBAcGFyYW0gdW5zdWJNc2cgQSBmdW5jdGlvbiB0byBnZW5lcmF0ZSB0aGUgdW5zdWJzY3JpcHRpb24gbWVzc2FnZSB0byBiZVxuICAgKiBzZW50IHRvIHRoZSBzZXJ2ZXIgYXQgZmluYWxpemF0aW9uLiBUaGlzIHdpbGwgc3RpbGwgYmUgcHJvY2Vzc2VkIGJ5IHRoZVxuICAgKiBzZXJpYWxpemVyIGluIHRoZSBXZWJTb2NrZXRTdWJqZWN0J3MgY29uZmlnLlxuICAgKiBAcGFyYW0gbWVzc2FnZUZpbHRlciBBIHByZWRpY2F0ZSBmb3Igc2VsZWN0aW5nIHRoZSBhcHByb3ByaWF0ZSBtZXNzYWdlc1xuICAgKiBmcm9tIHRoZSBzZXJ2ZXIgZm9yIHRoZSBvdXRwdXQgc3RyZWFtLlxuICAgKi9cbiAgbXVsdGlwbGV4KHN1Yk1zZzogKCkgPT4gYW55LCB1bnN1Yk1zZzogKCkgPT4gYW55LCBtZXNzYWdlRmlsdGVyOiAodmFsdWU6IFQpID0+IGJvb2xlYW4pIHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyOiBPYnNlcnZlcjxUPikgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgc2VsZi5uZXh0KHN1Yk1zZygpKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBzZWxmLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6ICh4KSA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChtZXNzYWdlRmlsdGVyKHgpKSB7XG4gICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoeCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3I6IChlcnIpID0+IG9ic2VydmVyLmVycm9yKGVyciksXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiBvYnNlcnZlci5jb21wbGV0ZSgpLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgc2VsZi5uZXh0KHVuc3ViTXNnKCkpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xuICAgICAgICB9XG4gICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX2Nvbm5lY3RTb2NrZXQoKSB7XG4gICAgY29uc3QgeyBXZWJTb2NrZXRDdG9yLCBwcm90b2NvbCwgdXJsLCBiaW5hcnlUeXBlIH0gPSB0aGlzLl9jb25maWc7XG4gICAgY29uc3Qgb2JzZXJ2ZXIgPSB0aGlzLl9vdXRwdXQ7XG5cbiAgICBsZXQgc29ja2V0OiBXZWJTb2NrZXQgfCBudWxsID0gbnVsbDtcbiAgICB0cnkge1xuICAgICAgc29ja2V0ID0gcHJvdG9jb2wgPyBuZXcgV2ViU29ja2V0Q3RvciEodXJsLCBwcm90b2NvbCkgOiBuZXcgV2ViU29ja2V0Q3RvciEodXJsKTtcbiAgICAgIHRoaXMuX3NvY2tldCA9IHNvY2tldDtcbiAgICAgIGlmIChiaW5hcnlUeXBlKSB7XG4gICAgICAgIHRoaXMuX3NvY2tldC5iaW5hcnlUeXBlID0gYmluYXJ5VHlwZTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBvYnNlcnZlci5lcnJvcihlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCgpID0+IHtcbiAgICAgIHRoaXMuX3NvY2tldCA9IG51bGw7XG4gICAgICBpZiAoc29ja2V0ICYmIHNvY2tldC5yZWFkeVN0YXRlID09PSAxKSB7XG4gICAgICAgIHNvY2tldC5jbG9zZSgpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgc29ja2V0Lm9ub3BlbiA9IChldnQ6IEV2ZW50KSA9PiB7XG4gICAgICBjb25zdCB7IF9zb2NrZXQgfSA9IHRoaXM7XG4gICAgICBpZiAoIV9zb2NrZXQpIHtcbiAgICAgICAgc29ja2V0IS5jbG9zZSgpO1xuICAgICAgICB0aGlzLl9yZXNldFN0YXRlKCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHsgb3Blbk9ic2VydmVyIH0gPSB0aGlzLl9jb25maWc7XG4gICAgICBpZiAob3Blbk9ic2VydmVyKSB7XG4gICAgICAgIG9wZW5PYnNlcnZlci5uZXh0KGV2dCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHF1ZXVlID0gdGhpcy5kZXN0aW5hdGlvbjtcblxuICAgICAgdGhpcy5kZXN0aW5hdGlvbiA9IFN1YnNjcmliZXIuY3JlYXRlPFQ+KFxuICAgICAgICAoeCkgPT4ge1xuICAgICAgICAgIGlmIChzb2NrZXQhLnJlYWR5U3RhdGUgPT09IDEpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGNvbnN0IHsgc2VyaWFsaXplciB9ID0gdGhpcy5fY29uZmlnO1xuICAgICAgICAgICAgICBzb2NrZXQhLnNlbmQoc2VyaWFsaXplciEoeCEpKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgdGhpcy5kZXN0aW5hdGlvbiEuZXJyb3IoZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICAoZXJyKSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBjbG9zaW5nT2JzZXJ2ZXIgfSA9IHRoaXMuX2NvbmZpZztcbiAgICAgICAgICBpZiAoY2xvc2luZ09ic2VydmVyKSB7XG4gICAgICAgICAgICBjbG9zaW5nT2JzZXJ2ZXIubmV4dCh1bmRlZmluZWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoZXJyICYmIGVyci5jb2RlKSB7XG4gICAgICAgICAgICBzb2NrZXQhLmNsb3NlKGVyci5jb2RlLCBlcnIucmVhc29uKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IobmV3IFR5cGVFcnJvcihXRUJTT0NLRVRTVUJKRUNUX0lOVkFMSURfRVJST1JfT0JKRUNUKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuX3Jlc2V0U3RhdGUoKTtcbiAgICAgICAgfSxcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgY2xvc2luZ09ic2VydmVyIH0gPSB0aGlzLl9jb25maWc7XG4gICAgICAgICAgaWYgKGNsb3NpbmdPYnNlcnZlcikge1xuICAgICAgICAgICAgY2xvc2luZ09ic2VydmVyLm5leHQodW5kZWZpbmVkKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgc29ja2V0IS5jbG9zZSgpO1xuICAgICAgICAgIHRoaXMuX3Jlc2V0U3RhdGUoKTtcbiAgICAgICAgfVxuICAgICAgKSBhcyBTdWJzY3JpYmVyPGFueT47XG5cbiAgICAgIGlmIChxdWV1ZSAmJiBxdWV1ZSBpbnN0YW5jZW9mIFJlcGxheVN1YmplY3QpIHtcbiAgICAgICAgc3Vic2NyaXB0aW9uLmFkZCgocXVldWUgYXMgUmVwbGF5U3ViamVjdDxUPikuc3Vic2NyaWJlKHRoaXMuZGVzdGluYXRpb24pKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgc29ja2V0Lm9uZXJyb3IgPSAoZTogRXZlbnQpID0+IHtcbiAgICAgIHRoaXMuX3Jlc2V0U3RhdGUoKTtcbiAgICAgIG9ic2VydmVyLmVycm9yKGUpO1xuICAgIH07XG5cbiAgICBzb2NrZXQub25jbG9zZSA9IChlOiBDbG9zZUV2ZW50KSA9PiB7XG4gICAgICBpZiAoc29ja2V0ID09PSB0aGlzLl9zb2NrZXQpIHtcbiAgICAgICAgdGhpcy5fcmVzZXRTdGF0ZSgpO1xuICAgICAgfVxuICAgICAgY29uc3QgeyBjbG9zZU9ic2VydmVyIH0gPSB0aGlzLl9jb25maWc7XG4gICAgICBpZiAoY2xvc2VPYnNlcnZlcikge1xuICAgICAgICBjbG9zZU9ic2VydmVyLm5leHQoZSk7XG4gICAgICB9XG4gICAgICBpZiAoZS53YXNDbGVhbikge1xuICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHNvY2tldC5vbm1lc3NhZ2UgPSAoZTogTWVzc2FnZUV2ZW50KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7IGRlc2VyaWFsaXplciB9ID0gdGhpcy5fY29uZmlnO1xuICAgICAgICBvYnNlcnZlci5uZXh0KGRlc2VyaWFsaXplciEoZSkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHJvdGVjdGVkIF9zdWJzY3JpYmUoc3Vic2NyaWJlcjogU3Vic2NyaWJlcjxUPik6IFN1YnNjcmlwdGlvbiB7XG4gICAgY29uc3QgeyBzb3VyY2UgfSA9IHRoaXM7XG4gICAgaWYgKHNvdXJjZSkge1xuICAgICAgcmV0dXJuIHNvdXJjZS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gICAgfVxuICAgIGlmICghdGhpcy5fc29ja2V0KSB7XG4gICAgICB0aGlzLl9jb25uZWN0U29ja2V0KCk7XG4gICAgfVxuICAgIHRoaXMuX291dHB1dC5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gICAgc3Vic2NyaWJlci5hZGQoKCkgPT4ge1xuICAgICAgY29uc3QgeyBfc29ja2V0IH0gPSB0aGlzO1xuICAgICAgaWYgKHRoaXMuX291dHB1dC5vYnNlcnZlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGlmIChfc29ja2V0ICYmIChfc29ja2V0LnJlYWR5U3RhdGUgPT09IDEgfHwgX3NvY2tldC5yZWFkeVN0YXRlID09PSAwKSkge1xuICAgICAgICAgIF9zb2NrZXQuY2xvc2UoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9yZXNldFN0YXRlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHN1YnNjcmliZXI7XG4gIH1cblxuICB1bnN1YnNjcmliZSgpIHtcbiAgICBjb25zdCB7IF9zb2NrZXQgfSA9IHRoaXM7XG4gICAgaWYgKF9zb2NrZXQgJiYgKF9zb2NrZXQucmVhZHlTdGF0ZSA9PT0gMSB8fCBfc29ja2V0LnJlYWR5U3RhdGUgPT09IDApKSB7XG4gICAgICBfc29ja2V0LmNsb3NlKCk7XG4gICAgfVxuICAgIHRoaXMuX3Jlc2V0U3RhdGUoKTtcbiAgICBzdXBlci51bnN1YnNjcmliZSgpO1xuICB9XG59XG4iXX0=
