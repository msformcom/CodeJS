import { Observable } from '../Observable.mjs';
import { async as asyncScheduler } from '../scheduler/async.mjs';
import { isScheduler } from '../util/isScheduler.mjs';
import { isValidDate } from '../util/isDate.mjs';
export function timer(dueTime = 0, intervalOrScheduler, scheduler = asyncScheduler) {
    // Since negative intervalDuration is treated as though no
    // interval was specified at all, we start with a negative number.
    let intervalDuration = -1;
    if (intervalOrScheduler != null) {
        // If we have a second argument, and it's a scheduler,
        // override the scheduler we had defaulted. Otherwise,
        // it must be an interval.
        if (isScheduler(intervalOrScheduler)) {
            scheduler = intervalOrScheduler;
        }
        else {
            // Note that this *could* be negative, in which case
            // it's like not passing an intervalDuration at all.
            intervalDuration = intervalOrScheduler;
        }
    }
    return new Observable((subscriber) => {
        // If a valid date is passed, calculate how long to wait before
        // executing the first value... otherwise, if it's a number just schedule
        // that many milliseconds (or scheduler-specified unit size) in the future.
        let due = isValidDate(dueTime) ? +dueTime - scheduler.now() : dueTime;
        if (due < 0) {
            // Ensure we don't schedule in the future.
            due = 0;
        }
        // The incrementing value we emit.
        let n = 0;
        // Start the timer.
        return scheduler.schedule(function () {
            if (!subscriber.closed) {
                // Emit the next value and increment.
                subscriber.next(n++);
                if (0 <= intervalDuration) {
                    // If we have a interval after the initial timer,
                    // reschedule with the period.
                    this.schedule(undefined, intervalDuration);
                }
                else {
                    // We didn't have an interval. So just complete.
                    subscriber.complete();
                }
            }
        }, due);
    });
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9yeGpzL3NyYy9pbnRlcm5hbC9vYnNlcnZhYmxlL3RpbWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLEtBQUssSUFBSSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM3RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBZ0k3QyxNQUFNLFVBQVUsS0FBSyxDQUNuQixVQUF5QixDQUFDLEVBQzFCLG1CQUE0QyxFQUM1QyxZQUEyQixjQUFjO0lBRXpDLDBEQUEwRDtJQUMxRCxrRUFBa0U7SUFDbEUsSUFBSSxnQkFBZ0IsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUUxQixJQUFJLG1CQUFtQixJQUFJLElBQUksRUFBRSxDQUFDO1FBQ2hDLHNEQUFzRDtRQUN0RCxzREFBc0Q7UUFDdEQsMEJBQTBCO1FBQzFCLElBQUksV0FBVyxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQztZQUNyQyxTQUFTLEdBQUcsbUJBQW1CLENBQUM7UUFDbEMsQ0FBQzthQUFNLENBQUM7WUFDTixvREFBb0Q7WUFDcEQsb0RBQW9EO1lBQ3BELGdCQUFnQixHQUFHLG1CQUFtQixDQUFDO1FBQ3pDLENBQUM7SUFDSCxDQUFDO0lBRUQsT0FBTyxJQUFJLFVBQVUsQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFO1FBQ25DLCtEQUErRDtRQUMvRCx5RUFBeUU7UUFDekUsMkVBQTJFO1FBQzNFLElBQUksR0FBRyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsU0FBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFFdkUsSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDWiwwQ0FBMEM7WUFDMUMsR0FBRyxHQUFHLENBQUMsQ0FBQztRQUNWLENBQUM7UUFFRCxrQ0FBa0M7UUFDbEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRVYsbUJBQW1CO1FBQ25CLE9BQU8sU0FBUyxDQUFDLFFBQVEsQ0FBQztZQUN4QixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUN2QixxQ0FBcUM7Z0JBQ3JDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFFckIsSUFBSSxDQUFDLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztvQkFDMUIsaURBQWlEO29CQUNqRCw4QkFBOEI7b0JBQzlCLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLGdCQUFnQixDQUFDLENBQUM7Z0JBQzdDLENBQUM7cUJBQU0sQ0FBQztvQkFDTixnREFBZ0Q7b0JBQ2hELFVBQVUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDeEIsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDVixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJmaWxlIjoibm9kZV9tb2R1bGVzL3J4anMvc3JjL2ludGVybmFsL29ic2VydmFibGUvdGltZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAnLi4vT2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBTY2hlZHVsZXJMaWtlIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgYXN5bmMgYXMgYXN5bmNTY2hlZHVsZXIgfSBmcm9tICcuLi9zY2hlZHVsZXIvYXN5bmMnO1xuaW1wb3J0IHsgaXNTY2hlZHVsZXIgfSBmcm9tICcuLi91dGlsL2lzU2NoZWR1bGVyJztcbmltcG9ydCB7IGlzVmFsaWREYXRlIH0gZnJvbSAnLi4vdXRpbC9pc0RhdGUnO1xuXG4vKipcbiAqIENyZWF0ZXMgYW4gb2JzZXJ2YWJsZSB0aGF0IHdpbGwgd2FpdCBmb3IgYSBzcGVjaWZpZWQgdGltZSBwZXJpb2QsIG9yIGV4YWN0IGRhdGUsIGJlZm9yZVxuICogZW1pdHRpbmcgdGhlIG51bWJlciAwLlxuICpcbiAqIDxzcGFuIGNsYXNzPVwiaW5mb3JtYWxcIj5Vc2VkIHRvIGVtaXQgYSBub3RpZmljYXRpb24gYWZ0ZXIgYSBkZWxheS48L3NwYW4+XG4gKlxuICogVGhpcyBvYnNlcnZhYmxlIGlzIHVzZWZ1bCBmb3IgY3JlYXRpbmcgZGVsYXlzIGluIGNvZGUsIG9yIHJhY2luZyBhZ2FpbnN0IG90aGVyIHZhbHVlc1xuICogZm9yIGFkLWhvYyB0aW1lb3V0cy5cbiAqXG4gKiBUaGUgYGRlbGF5YCBpcyBzcGVjaWZpZWQgYnkgZGVmYXVsdCBpbiBtaWxsaXNlY29uZHMsIGhvd2V2ZXIgcHJvdmlkaW5nIGEgY3VzdG9tIHNjaGVkdWxlciBjb3VsZFxuICogY3JlYXRlIGEgZGlmZmVyZW50IGJlaGF2aW9yLlxuICpcbiAqICMjIEV4YW1wbGVzXG4gKlxuICogV2FpdCAzIHNlY29uZHMgYW5kIHN0YXJ0IGFub3RoZXIgb2JzZXJ2YWJsZVxuICpcbiAqIFlvdSBtaWdodCB3YW50IHRvIHVzZSBgdGltZXJgIHRvIGRlbGF5IHN1YnNjcmlwdGlvbiB0byBhblxuICogb2JzZXJ2YWJsZSBieSBhIHNldCBhbW91bnQgb2YgdGltZS4gSGVyZSB3ZSB1c2UgYSB0aW1lciB3aXRoXG4gKiB7QGxpbmsgY29uY2F0TWFwVG99IG9yIHtAbGluayBjb25jYXRNYXB9IGluIG9yZGVyIHRvIHdhaXRcbiAqIGEgZmV3IHNlY29uZHMgYW5kIHN0YXJ0IGEgc3Vic2NyaXB0aW9uIHRvIGEgc291cmNlLlxuICpcbiAqIGBgYHRzXG4gKiBpbXBvcnQgeyBvZiwgdGltZXIsIGNvbmNhdE1hcCB9IGZyb20gJ3J4anMnO1xuICpcbiAqIC8vIFRoaXMgY291bGQgYmUgYW55IG9ic2VydmFibGVcbiAqIGNvbnN0IHNvdXJjZSA9IG9mKDEsIDIsIDMpO1xuICpcbiAqIHRpbWVyKDMwMDApXG4gKiAgIC5waXBlKGNvbmNhdE1hcCgoKSA9PiBzb3VyY2UpKVxuICogICAuc3Vic2NyaWJlKGNvbnNvbGUubG9nKTtcbiAqIGBgYFxuICpcbiAqIFRha2UgYWxsIHZhbHVlcyB1bnRpbCB0aGUgc3RhcnQgb2YgdGhlIG5leHQgbWludXRlXG4gKlxuICogVXNpbmcgYSBgRGF0ZWAgYXMgdGhlIHRyaWdnZXIgZm9yIHRoZSBmaXJzdCBlbWlzc2lvbiwgeW91IGNhblxuICogZG8gdGhpbmdzIGxpa2Ugd2FpdCB1bnRpbCBtaWRuaWdodCB0byBmaXJlIGFuIGV2ZW50LCBvciBpbiB0aGlzIGNhc2UsXG4gKiB3YWl0IHVudGlsIGEgbmV3IG1pbnV0ZSBzdGFydHMgKGNob3NlbiBzbyB0aGUgZXhhbXBsZSB3b3VsZG4ndCB0YWtlXG4gKiB0b28gbG9uZyB0byBydW4pIGluIG9yZGVyIHRvIHN0b3Agd2F0Y2hpbmcgYSBzdHJlYW0uIExldmVyYWdpbmdcbiAqIHtAbGluayB0YWtlVW50aWx9LlxuICpcbiAqIGBgYHRzXG4gKiBpbXBvcnQgeyBpbnRlcnZhbCwgdGFrZVVudGlsLCB0aW1lciB9IGZyb20gJ3J4anMnO1xuICpcbiAqIC8vIEJ1aWxkIGEgRGF0ZSBvYmplY3QgdGhhdCBtYXJrcyB0aGVcbiAqIC8vIG5leHQgbWludXRlLlxuICogY29uc3QgY3VycmVudERhdGUgPSBuZXcgRGF0ZSgpO1xuICogY29uc3Qgc3RhcnRPZk5leHRNaW51dGUgPSBuZXcgRGF0ZShcbiAqICAgY3VycmVudERhdGUuZ2V0RnVsbFllYXIoKSxcbiAqICAgY3VycmVudERhdGUuZ2V0TW9udGgoKSxcbiAqICAgY3VycmVudERhdGUuZ2V0RGF0ZSgpLFxuICogICBjdXJyZW50RGF0ZS5nZXRIb3VycygpLFxuICogICBjdXJyZW50RGF0ZS5nZXRNaW51dGVzKCkgKyAxXG4gKiApO1xuICpcbiAqIC8vIFRoaXMgY291bGQgYmUgYW55IG9ic2VydmFibGUgc3RyZWFtXG4gKiBjb25zdCBzb3VyY2UgPSBpbnRlcnZhbCgxMDAwKTtcbiAqXG4gKiBjb25zdCByZXN1bHQgPSBzb3VyY2UucGlwZShcbiAqICAgdGFrZVVudGlsKHRpbWVyKHN0YXJ0T2ZOZXh0TWludXRlKSlcbiAqICk7XG4gKlxuICogcmVzdWx0LnN1YnNjcmliZShjb25zb2xlLmxvZyk7XG4gKiBgYGBcbiAqXG4gKiAjIyMgS25vd24gTGltaXRhdGlvbnNcbiAqXG4gKiAtIFRoZSB7QGxpbmsgYXN5bmNTY2hlZHVsZXJ9IHVzZXMgYHNldFRpbWVvdXRgIHdoaWNoIGhhcyBsaW1pdGF0aW9ucyBmb3IgaG93IGZhciBpbiB0aGUgZnV0dXJlIGl0IGNhbiBiZSBzY2hlZHVsZWQuXG4gKlxuICogLSBJZiBhIGBzY2hlZHVsZXJgIGlzIHByb3ZpZGVkIHRoYXQgcmV0dXJucyBhIHRpbWVzdGFtcCBvdGhlciB0aGFuIGFuIGVwb2NoIGZyb20gYG5vdygpYCwgYW5kXG4gKiBhIGBEYXRlYCBvYmplY3QgaXMgcGFzc2VkIHRvIHRoZSBgZHVlVGltZWAgYXJndW1lbnQsIHRoZSBjYWxjdWxhdGlvbiBmb3Igd2hlbiB0aGUgZmlyc3QgZW1pc3Npb25cbiAqIHNob3VsZCBvY2N1ciB3aWxsIGJlIGluY29ycmVjdC4gSW4gdGhpcyBjYXNlLCBpdCB3b3VsZCBiZSBiZXN0IHRvIGRvIHlvdXIgb3duIGNhbGN1bGF0aW9uc1xuICogYWhlYWQgb2YgdGltZSwgYW5kIHBhc3MgYSBgbnVtYmVyYCBpbiBhcyB0aGUgYGR1ZVRpbWVgLlxuICpcbiAqIEBwYXJhbSBkdWUgSWYgYSBgbnVtYmVyYCwgdGhlIGFtb3VudCBvZiB0aW1lIGluIG1pbGxpc2Vjb25kcyB0byB3YWl0IGJlZm9yZSBlbWl0dGluZy5cbiAqIElmIGEgYERhdGVgLCB0aGUgZXhhY3QgdGltZSBhdCB3aGljaCB0byBlbWl0LlxuICogQHBhcmFtIHNjaGVkdWxlciBUaGUgc2NoZWR1bGVyIHRvIHVzZSB0byBzY2hlZHVsZSB0aGUgZGVsYXkuIERlZmF1bHRzIHRvIHtAbGluayBhc3luY1NjaGVkdWxlcn0uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0aW1lcihkdWU6IG51bWJlciB8IERhdGUsIHNjaGVkdWxlcj86IFNjaGVkdWxlckxpa2UpOiBPYnNlcnZhYmxlPDA+O1xuXG4vKipcbiAqIENyZWF0ZXMgYW4gb2JzZXJ2YWJsZSB0aGF0IHN0YXJ0cyBhbiBpbnRlcnZhbCBhZnRlciBhIHNwZWNpZmllZCBkZWxheSwgZW1pdHRpbmcgaW5jcmVtZW50aW5nIG51bWJlcnMgLS0gc3RhcnRpbmcgYXQgYDBgIC0tXG4gKiBvbiBlYWNoIGludGVydmFsIGFmdGVyIHdvcmRzLlxuICpcbiAqIFRoZSBgZGVsYXlgIGFuZCBgaW50ZXJ2YWxEdXJhdGlvbmAgYXJlIHNwZWNpZmllZCBieSBkZWZhdWx0IGluIG1pbGxpc2Vjb25kcywgaG93ZXZlciBwcm92aWRpbmcgYSBjdXN0b20gc2NoZWR1bGVyIGNvdWxkXG4gKiBjcmVhdGUgYSBkaWZmZXJlbnQgYmVoYXZpb3IuXG4gKlxuICogIyMgRXhhbXBsZVxuICpcbiAqICMjIyBTdGFydCBhbiBpbnRlcnZhbCB0aGF0IHN0YXJ0cyByaWdodCBhd2F5XG4gKlxuICogU2luY2Uge0BsaW5rIGludGVydmFsfSB3YWl0cyBmb3IgdGhlIHBhc3NlZCBkZWxheSBiZWZvcmUgc3RhcnRpbmcsXG4gKiBzb21ldGltZXMgdGhhdCdzIG5vdCBpZGVhbC4gWW91IG1heSB3YW50IHRvIHN0YXJ0IGFuIGludGVydmFsIGltbWVkaWF0ZWx5LlxuICogYHRpbWVyYCB3b3JrcyB3ZWxsIGZvciB0aGlzLiBIZXJlIHdlIGhhdmUgYm90aCBzaWRlLWJ5LXNpZGUgc28geW91IGNhblxuICogc2VlIHRoZW0gaW4gY29tcGFyaXNvbi5cbiAqXG4gKiBOb3RlIHRoYXQgdGhpcyBvYnNlcnZhYmxlIHdpbGwgbmV2ZXIgY29tcGxldGUuXG4gKlxuICogYGBgdHNcbiAqIGltcG9ydCB7IHRpbWVyLCBpbnRlcnZhbCB9IGZyb20gJ3J4anMnO1xuICpcbiAqIHRpbWVyKDAsIDEwMDApLnN1YnNjcmliZShuID0+IGNvbnNvbGUubG9nKCd0aW1lcicsIG4pKTtcbiAqIGludGVydmFsKDEwMDApLnN1YnNjcmliZShuID0+IGNvbnNvbGUubG9nKCdpbnRlcnZhbCcsIG4pKTtcbiAqIGBgYFxuICpcbiAqICMjIyBLbm93biBMaW1pdGF0aW9uc1xuICpcbiAqIC0gVGhlIHtAbGluayBhc3luY1NjaGVkdWxlcn0gdXNlcyBgc2V0VGltZW91dGAgd2hpY2ggaGFzIGxpbWl0YXRpb25zIGZvciBob3cgZmFyIGluIHRoZSBmdXR1cmUgaXQgY2FuIGJlIHNjaGVkdWxlZC5cbiAqXG4gKiAtIElmIGEgYHNjaGVkdWxlcmAgaXMgcHJvdmlkZWQgdGhhdCByZXR1cm5zIGEgdGltZXN0YW1wIG90aGVyIHRoYW4gYW4gZXBvY2ggZnJvbSBgbm93KClgLCBhbmRcbiAqIGEgYERhdGVgIG9iamVjdCBpcyBwYXNzZWQgdG8gdGhlIGBkdWVUaW1lYCBhcmd1bWVudCwgdGhlIGNhbGN1bGF0aW9uIGZvciB3aGVuIHRoZSBmaXJzdCBlbWlzc2lvblxuICogc2hvdWxkIG9jY3VyIHdpbGwgYmUgaW5jb3JyZWN0LiBJbiB0aGlzIGNhc2UsIGl0IHdvdWxkIGJlIGJlc3QgdG8gZG8geW91ciBvd24gY2FsY3VsYXRpb25zXG4gKiBhaGVhZCBvZiB0aW1lLCBhbmQgcGFzcyBhIGBudW1iZXJgIGluIGFzIHRoZSBgc3RhcnREdWVgLlxuICogQHBhcmFtIHN0YXJ0RHVlIElmIGEgYG51bWJlcmAsIGlzIHRoZSB0aW1lIHRvIHdhaXQgYmVmb3JlIHN0YXJ0aW5nIHRoZSBpbnRlcnZhbC5cbiAqIElmIGEgYERhdGVgLCBpcyB0aGUgZXhhY3QgdGltZSBhdCB3aGljaCB0byBzdGFydCB0aGUgaW50ZXJ2YWwuXG4gKiBAcGFyYW0gaW50ZXJ2YWxEdXJhdGlvbiBUaGUgZGVsYXkgYmV0d2VlbiBlYWNoIHZhbHVlIGVtaXR0ZWQgaW4gdGhlIGludGVydmFsLiBQYXNzaW5nIGFcbiAqIG5lZ2F0aXZlIG51bWJlciBoZXJlIHdpbGwgcmVzdWx0IGluIGltbWVkaWF0ZSBjb21wbGV0aW9uIGFmdGVyIHRoZSBmaXJzdCB2YWx1ZSBpcyBlbWl0dGVkLCBhcyB0aG91Z2hcbiAqIG5vIGBpbnRlcnZhbER1cmF0aW9uYCB3YXMgcGFzc2VkIGF0IGFsbC5cbiAqIEBwYXJhbSBzY2hlZHVsZXIgVGhlIHNjaGVkdWxlciB0byB1c2UgdG8gc2NoZWR1bGUgdGhlIGRlbGF5LiBEZWZhdWx0cyB0byB7QGxpbmsgYXN5bmNTY2hlZHVsZXJ9LlxuICovXG5leHBvcnQgZnVuY3Rpb24gdGltZXIoc3RhcnREdWU6IG51bWJlciB8IERhdGUsIGludGVydmFsRHVyYXRpb246IG51bWJlciwgc2NoZWR1bGVyPzogU2NoZWR1bGVyTGlrZSk6IE9ic2VydmFibGU8bnVtYmVyPjtcblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBUaGUgc2lnbmF0dXJlIGFsbG93aW5nIGB1bmRlZmluZWRgIHRvIGJlIHBhc3NlZCBmb3IgYGludGVydmFsRHVyYXRpb25gIHdpbGwgYmUgcmVtb3ZlZCBpbiB2OC4gVXNlIHRoZSBgdGltZXIoZHVlVGltZSwgc2NoZWR1bGVyPylgIHNpZ25hdHVyZSBpbnN0ZWFkLlxuICovXG5leHBvcnQgZnVuY3Rpb24gdGltZXIoZHVlVGltZTogbnVtYmVyIHwgRGF0ZSwgdW51c2VkOiB1bmRlZmluZWQsIHNjaGVkdWxlcj86IFNjaGVkdWxlckxpa2UpOiBPYnNlcnZhYmxlPDA+O1xuXG5leHBvcnQgZnVuY3Rpb24gdGltZXIoXG4gIGR1ZVRpbWU6IG51bWJlciB8IERhdGUgPSAwLFxuICBpbnRlcnZhbE9yU2NoZWR1bGVyPzogbnVtYmVyIHwgU2NoZWR1bGVyTGlrZSxcbiAgc2NoZWR1bGVyOiBTY2hlZHVsZXJMaWtlID0gYXN5bmNTY2hlZHVsZXJcbik6IE9ic2VydmFibGU8bnVtYmVyPiB7XG4gIC8vIFNpbmNlIG5lZ2F0aXZlIGludGVydmFsRHVyYXRpb24gaXMgdHJlYXRlZCBhcyB0aG91Z2ggbm9cbiAgLy8gaW50ZXJ2YWwgd2FzIHNwZWNpZmllZCBhdCBhbGwsIHdlIHN0YXJ0IHdpdGggYSBuZWdhdGl2ZSBudW1iZXIuXG4gIGxldCBpbnRlcnZhbER1cmF0aW9uID0gLTE7XG5cbiAgaWYgKGludGVydmFsT3JTY2hlZHVsZXIgIT0gbnVsbCkge1xuICAgIC8vIElmIHdlIGhhdmUgYSBzZWNvbmQgYXJndW1lbnQsIGFuZCBpdCdzIGEgc2NoZWR1bGVyLFxuICAgIC8vIG92ZXJyaWRlIHRoZSBzY2hlZHVsZXIgd2UgaGFkIGRlZmF1bHRlZC4gT3RoZXJ3aXNlLFxuICAgIC8vIGl0IG11c3QgYmUgYW4gaW50ZXJ2YWwuXG4gICAgaWYgKGlzU2NoZWR1bGVyKGludGVydmFsT3JTY2hlZHVsZXIpKSB7XG4gICAgICBzY2hlZHVsZXIgPSBpbnRlcnZhbE9yU2NoZWR1bGVyO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBOb3RlIHRoYXQgdGhpcyAqY291bGQqIGJlIG5lZ2F0aXZlLCBpbiB3aGljaCBjYXNlXG4gICAgICAvLyBpdCdzIGxpa2Ugbm90IHBhc3NpbmcgYW4gaW50ZXJ2YWxEdXJhdGlvbiBhdCBhbGwuXG4gICAgICBpbnRlcnZhbER1cmF0aW9uID0gaW50ZXJ2YWxPclNjaGVkdWxlcjtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbmV3IE9ic2VydmFibGUoKHN1YnNjcmliZXIpID0+IHtcbiAgICAvLyBJZiBhIHZhbGlkIGRhdGUgaXMgcGFzc2VkLCBjYWxjdWxhdGUgaG93IGxvbmcgdG8gd2FpdCBiZWZvcmVcbiAgICAvLyBleGVjdXRpbmcgdGhlIGZpcnN0IHZhbHVlLi4uIG90aGVyd2lzZSwgaWYgaXQncyBhIG51bWJlciBqdXN0IHNjaGVkdWxlXG4gICAgLy8gdGhhdCBtYW55IG1pbGxpc2Vjb25kcyAob3Igc2NoZWR1bGVyLXNwZWNpZmllZCB1bml0IHNpemUpIGluIHRoZSBmdXR1cmUuXG4gICAgbGV0IGR1ZSA9IGlzVmFsaWREYXRlKGR1ZVRpbWUpID8gK2R1ZVRpbWUgLSBzY2hlZHVsZXIhLm5vdygpIDogZHVlVGltZTtcblxuICAgIGlmIChkdWUgPCAwKSB7XG4gICAgICAvLyBFbnN1cmUgd2UgZG9uJ3Qgc2NoZWR1bGUgaW4gdGhlIGZ1dHVyZS5cbiAgICAgIGR1ZSA9IDA7XG4gICAgfVxuXG4gICAgLy8gVGhlIGluY3JlbWVudGluZyB2YWx1ZSB3ZSBlbWl0LlxuICAgIGxldCBuID0gMDtcblxuICAgIC8vIFN0YXJ0IHRoZSB0aW1lci5cbiAgICByZXR1cm4gc2NoZWR1bGVyLnNjaGVkdWxlKGZ1bmN0aW9uICgpIHtcbiAgICAgIGlmICghc3Vic2NyaWJlci5jbG9zZWQpIHtcbiAgICAgICAgLy8gRW1pdCB0aGUgbmV4dCB2YWx1ZSBhbmQgaW5jcmVtZW50LlxuICAgICAgICBzdWJzY3JpYmVyLm5leHQobisrKTtcblxuICAgICAgICBpZiAoMCA8PSBpbnRlcnZhbER1cmF0aW9uKSB7XG4gICAgICAgICAgLy8gSWYgd2UgaGF2ZSBhIGludGVydmFsIGFmdGVyIHRoZSBpbml0aWFsIHRpbWVyLFxuICAgICAgICAgIC8vIHJlc2NoZWR1bGUgd2l0aCB0aGUgcGVyaW9kLlxuICAgICAgICAgIHRoaXMuc2NoZWR1bGUodW5kZWZpbmVkLCBpbnRlcnZhbER1cmF0aW9uKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBXZSBkaWRuJ3QgaGF2ZSBhbiBpbnRlcnZhbC4gU28ganVzdCBjb21wbGV0ZS5cbiAgICAgICAgICBzdWJzY3JpYmVyLmNvbXBsZXRlKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LCBkdWUpO1xuICB9KTtcbn1cbiJdfQ==
